{% load static %}

<!DOCTYPE html>
<html lang="en" style="height: 100%;">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  
  <title>OmnyComm</title>

  <link rel="stylesheet" href="{% static 'WAMSApp/css/materialize.min.css' %}">

  <link href="{% static 'WAMSApp/css/style.css' %}" type="text/css" rel="stylesheet" media="screen,projection"/>

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/0.3.0/gridstack.min.css" />

  <link href="{% static 'WAMSApp/css/flyer.css' %}" type="text/css" rel="stylesheet" media="screen,projection"/>

  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

</head>

<body class="scroll-style-1" style="font-family: 'AvenirNext';">

  <style type="text/css">
    @font-face {
      font-family: AvenirNext;
      src: url("{% static 'WAMSApp/fonts/Avenir-Next-Font/AvenirNextLTPro-Demi.otf' %}");
    }

    @font-face {
      font-family: AvenirNextBold;
      src: url("{% static 'WAMSApp/fonts/Avenir-Next-Font/AvenirNextLTPro-Bold.otf' %}");
    }


    @font-face {
      font-family: AvenirNextRegular;
      src: url("{% static 'WAMSApp/fonts/Avenir-Next-Font/AvenirNextLTPro-Regular.otf' %}");
    }

    @font-face {
      font-family: AvenirNext-Flyer;
      src: url("{% static 'WAMSApp/fonts/Avenir-Next-Font/AvenirNextLTPro-DemiCn.otf' %}");
    }

    @font-face {
      font-family: Helvetica;
      src: url("{% static 'WAMSApp/fonts/Helvetica/Helvetica.ttf' %}");
    }

    @font-face {
      font-family: BebasNeueRegular;
      src: url("{% static 'WAMSApp/fonts/general/BebasNeueRegular.otf' %}");
    }

    @font-face {
      font-family: GothamBookRegular;
      src: url("{% static 'WAMSApp/fonts/general/GothamBookRegular.otf' %}");
    }

    @font-face {
      font-family: FrankRegular;
      src: url("{% static 'WAMSApp/fonts/general/FrankRegular.otf' %}");
    }
  </style>

  {% csrf_token %}

  <script type="text/javascript" src="{% static 'WAMSApp/js/jquery.js' %}"></script>
  
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.0/jquery-ui.min.js" type="text/javascript"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/gridstack@1.1.1/dist/gridstack.all.js"></script>

  
  <div class="row" style="margin-bottom: 0em;">

    <div id="editor-division-1" class="scroll-style-1 col m4" style="position: fixed;height: 100vh;overflow-y: scroll;background-color: #36404A;">
      <div class="row custom-bc2" style="margin-bottom: 0em;">
        <div class="col s1" style="margin-top: 0.4em;">
          <i class="material-icons custom-text1" style="position: absolute;margin-top: 0.5em;margin-left: 0.5em;">search</i>
        </div>
        <div class="input-field col s11" style="margin-bottom: 0em;margin-top: 0.4em;">
          <input id="autocomplete-input" placeholder="Search by product name" type="text" class="validate flyer-search custom-text3" style="border-bottom: none;box-shadow: none;text-indent: 0.5em;">
        </div>
      </div>
      
      <div class="row">

        <!-- Product Basket -->
        <div class="col s12" style="width: 90%;margin-left: 5%;padding-top: 1em;margin-top: 1em;">
          <span style="font-family: 'AvenirNextRegular';color:#717171;">
            <i class="material-icons custom-text1" style="position: absolute;font-size: 1.4em;margin-left: -0.5em;">shopping_basket</i>
            <span style="margin-left: 1.5em;font-size: 14px;font-weight: bold;" class="custom-text1">Product Basket</span>
          </span>
          
          <div id="product-basket-list-div" class="scroll-style-1 row custom-bc2 hoverable" style="margin-top:0.5em;min-height:6em;max-height: 20em;overflow-y: auto;padding-left: 1.2em;padding-right: 0.4em;padding-top: 0.8em;">
          </div>
        </div>


        <!-- Image Categories -->
        <div class="col s12" style="width: 90%;margin-left: 5%;margin-top: 1em;">
          <span style="font-family: 'AvenirNextRegular';color:#717171;">
            <i class="material-icons custom-text1" style="position: absolute;font-size: 1.5em;margin-left: -0.5em;">image</i>
            <span class="custom-text1" style="margin-left: 1.5em;font-size: 14px;font-weight: bold;">Image Categories</span>
          </span>

          <div class="scroll-style-1 row custom-bc2 hoverable" style="margin-top:0.5em;">
            <div class="col s12">
              <div id="image-categories-thumbnails-div" class="scroll-style-1 row" style="max-height: 10em;overflow-y:auto;margin-bottom: 0em;">
              </div>
            </div>
          </div>
        </div>


        <!-- External Image Categories -->
        <div class="col s12" style="width: 90%;margin-left: 5%;margin-top: 1em;position: relative;">
          <span style="font-family: 'AvenirNextRegular';color:#717171;">
            <i class="material-icons custom-text1" style="position: absolute;font-size: 1.5em;margin-left: -0.5em;">image</i>
            <span style="margin-left: 1.5em;font-size: 14px;font-weight: bold;" class="custom-text1">External Image Categories</span>
            <a href="#upload-image-modal" id="import-btn" class="right modal-trigger btn-floating btn-small waves-effect waves-light green" style="transform: scale(0.7);position: absolute;right: 0px;top: -8px;">
              <i class="material-icons" style="background-color:#1ABC9C;">add</i>
            </a>
          </span>
          <div class="scroll-style-1 row custom-bc2 hoverable" style="margin-top:0.5em;">
            <div class="col s12">
              <div id="external-image-categories-thumbnails-div" class="scroll-style-1 row" style="min-height:10em;max-height: 10em;overflow-y:auto;margin-bottom: 0em;">
              </div>
            </div>
          </div>
        </div>






        <!-- Tag Bucket -->
        <div class="col s12" style="width: 90%;margin-left: 5%;margin-top: 1em;position: relative;">
          <span style="font-family: 'AvenirNextRegular';color:#717171;margin-bottom: 1em;">
            <i class="material-icons custom-text1" style="position: absolute;font-size: 1.5em;margin-left: -0.5em;">image</i>
            <span class="custom-text1" style="margin-left: 1.5em;font-size: 14px;font-weight: bold;">Tag Bucket</span>

            <div class="row" style="margin-bottom: 0em;">
              <div class="col s6">
                <div class="switch">
                  <label>
                    One
                    <input id="tag-multi-option" type="checkbox">
                    <span class="lever"></span>
                    All
                  </label>
                </div>
              </div>

              <div class="col s6">
                <div class="switch">
                  <label>
                    Add
                    <input id="tag-delete-option" type="checkbox">
                    <span class="lever"></span>
                    Delete
                  </label>
                </div>
              </div>
            </div>

            <a href="#add-new-tag-modal" class="right modal-trigger btn-floating btn-small waves-effect waves-light green" style="transform: scale(0.7);position: absolute;right: 0px;top: -8px; ">
              <i class="material-icons" style="background-color: #1ABC9C;">add</i>
            </a>
          </span>

          <div id="tag-bucket-thumbnails-div" class="scroll-style-1 row custom-bc2 hoverable" style="margin-top:0.5em;max-height:10em;overflow-y:auto;padding-top: 0.6em;">
          </div>
        </div>





        <!-- Price Tag Bucket -->
        <div class="col s12" style="width: 90%;margin-left: 5%;margin-top: 1em;position: relative;">
          <span style="font-family: 'AvenirNextRegular';color:#717171;margin-bottom: 1em;">
            <i class="material-icons custom-text1" style="position: absolute;font-size: 1.5em;margin-left: -0.5em;">image</i>
            <span class="custom-text1" style="margin-left: 1.5em;font-size: 14px;font-weight: bold;">Price Tag Bucket</span>

            <div class="row" style="margin-bottom: 0em;">
              <div class="col s6">
                <div class="switch">
                  <label>
                    One
                    <input id="price-tag-multi-option" type="checkbox">
                    <span class="lever"></span>
                    All
                  </label>
                </div>
              </div>

              <div class="col s6">
                <div class="switch">
                  <label>
                    Add
                    <input id="price-tag-delete-option" type="checkbox">
                    <span class="lever"></span>
                    Delete
                  </label>
                </div>
              </div>
            </div>

            <a href="#add-new-price-tag-modal" class="right modal-trigger btn-floating btn-small waves-effect waves-light green" style="transform: scale(0.7);position: absolute;right: 0px;top: -8px; ">
              <i class="material-icons" style="background-color: #1ABC9C;">add</i>
            </a>
          </span>

          <div id="price-tag-bucket-thumbnails-div" class="scroll-style-1 row custom-bc2 hoverable" style="margin-top:0.5em;max-height:10em;overflow-y:auto;padding-top: 0.6em;">
          </div>
        </div>







        <!-- Image Options -->
        <div class="col s12" style="width: 90%;margin-left: 5%;margin-top: 1em;position: relative;">
          <ul class="collapsible" style="width:100%;border:none;">
            <li style="width:100%;">
              <div class="collapsible-header custom-bc2 white-text" style="width:100%;border-color:black;">
                <i class="material-icons">camera_font</i>Image Resizer
              </div>
              <div class="collapsible-body" style="width:100%;">
                <p class="range-field" style="width:100%;">
                  <input class="custom-slider" type="range" id="image-resizer" min="10" max="150" value="50" />
                </p>
              </div>
            </li>

            <li style="width:100%;">
              <div class="collapsible-header custom-bc2 white-text" style="width:100%;border-color:black;">
                <i class="material-icons">compare</i>All Image Resizer
              </div>
              <div class="collapsible-body" style="width:100%;">
                <p class="range-field" style="width:100%;">
                  <input class="custom-slider" type="range" id="all-image-resizer" min="10" max="150" value="50" />
                </p>
              </div>
            </li>

            <li style="width:100%;">
              <div class="collapsible-header custom-bc2 white-text" style="width:100%;border-color:black;">
                <i class="material-icons">camera_font</i>Image Rotate
              </div>
              <div class="collapsible-body" style="width:100%;">
                <p class="range-field" style="width:100%;">
                  <input class="custom-slider" type="range" id="image-rotator" min="-90" max="90" value="0" />
                </p>
              </div>
            </li>

            <li style="width:100%;">
              <div class="collapsible-header custom-bc2 white-text" style="width:100%;border-color:black;">
                <i class="material-icons">compare</i>All Image Rotate
              </div>
              <div class="collapsible-body" style="width:100%;">
                <p class="range-field" style="width:100%;">
                  <input class="custom-slider" type="range" id="all-image-rotator" min="-90" max="90" value="0" />
                </p>
              </div>
            </li>
          </ul>
        </div>



        






        <!-- Font Settings -->        
        <div class="col s12" style="width: 90%;margin-left: 5%;margin-top: 1em;">

          <span style="font-family: 'AvenirNextRegular';color:#717171;">
            <i class="material-icons custom-text1" style="position: absolute;font-size: 1.3em;margin-left: -0.5em;">font_download</i>
            <span class="custom-text1" style="margin-left: 1.5em;font-size: 14px;font-weight: bold;">Font Settings</span>
            <div class="switch right">
              <label>
                One
                <input id="font-multi-option" type="checkbox" checked>
                <span class="lever"></span>
                All
              </label>
            </div>

          </span>
          
          <div class="row custom-bc2 hoverable" style="margin-top:0.5em;padding:5px">
            <div class="col s6" style="margin: 0em;padding-top:0em;">
              <input id="font-size" type="number" value="12" class="custom-text3">
            </div>

            <div class="col s6" style="margin: 0em;padding-top:0em;">
                <select id="font-family">
                  <option value="Arial">Arial</option> 
                  <option value="Impact">Impact</option>
                  <option value="Helvetica" selected>Helvetica</option>
                  <option value="AvenirNextRegular">AvenirNextRegular</option>
                  <option value="BebasNeueRegular">Bebas Neue Regular</option>
                  <option value="FrankRegular">Frank Regular</option>
                  <option value="GothamBookRegular">Gotham Book Regular</option>
                </select>
            </div>

            <div class="col s6" style="margin-top: 1em;padding-right: 0em;">
              <a href="#!" id="format-bold-btn" bold=false><i class="material-icons white-text">format_bold</i></a>
              <a href="#!" id="format-underlined-btn" underlined=false><i class="material-icons white-text">format_underlined</i></a>
              <a href="#!" id="format-italic-btn" italic=false><i class="material-icons white-text">format_italic</i></a>
              <a href="#!" id="font-align-left-btn" class="font-alignment" value="left"><i class="material-icons white-text">format_align_left</i></a>
              <a href="#!" id="font-align-center-btn" class="font-alignment" value="center"><i class="material-icons white-text">format_align_center</i></a>
              <a href="#!" id="font-align-right-btn" class="font-alignment" value="right"><i class="material-icons white-text">format_align_right</i></a>
            </div> 

            <div class="col s6" style="margin-top: 1em;padding-top:0em;">
              <input id="font-color" type="color" value="#000000" class="custom-text3">
            </div>

          </div>
        </div>







        <!-- General Settings -->        
        <div class="col s12" style="width: 90%;margin-left: 5%;margin-top: 1em;">

          <span style="font-family: 'AvenirNextRegular';color:#717171;">
            <i class="material-icons custom-text1" style="position: absolute;font-size: 1.3em;margin-left: -0.5em;">border_all</i>
            <span class="custom-text1" style="margin-left: 1.5em;font-size: 14px;font-weight: bold;">General Settings</span>
          </span>
          
          <div class="row custom-bc2 hoverable" style="margin-top:0.5em;padding-top:0.6em;padding-bottom: 0.6em;">
            <div class="col s6" style="margin-top: 1em;">
              <label>
                <input id="border-option" class="filled-in checkbox-flyer" type="checkbox" checked />
                <span class="left" style="font-size: 14px;font-family: 'AvenirNext';">Border Visible</span>
              </label>&nbsp;&nbsp;

              <input id="border-color" type="color" value="black"> 
            </div>

            <div class="col s6" style="margin-top: 1em;">
              <label>
                <input id="white-option" class="filled-in checkbox-flyer" type="checkbox" checked />
                <span class="left" style="font-size: 14px;font-family: 'AvenirNext';">White Container</span>
              </label>
            </div>

          </div>
        </div>








        <!-- Background Image Bucket -->
        <div class="col s12" style="width: 90%;margin-left: 5%;margin-top: 1em;position: relative;">
          <span style="font-family: 'AvenirNextRegular';color:#717171;margin-bottom: 1em;">
            <i class="material-icons custom-text1" style="position: absolute;font-size: 1.5em;margin-left: -0.5em;">image</i>
            <span class="custom-text1" style="margin-left: 1.5em;font-size: 14px;font-weight: bold;">Background Image Bucket</span>
            <a href="#add-new-bg-modal" class="right modal-trigger btn-floating btn-small waves-effect waves-light green" style="transform: scale(0.7);position: absolute;right: 0px;top: -8px; ">
              <i class="material-icons" style="background-color: #1ABC9C;">add</i>
            </a>
          </span>

          <div id="background-image-bucket-thumbnails-div" class="scroll-style-1 row custom-bc2 hoverable" style="margin-top:0.5em;max-height:10em;overflow-y:auto;padding-top: 0.6em;">
          </div>
        </div>



        <div class="col s12" style="width: 90%;margin-left: 5%;padding-right: 0em;">
          <a id="save-flyer-template-btn" class="btn right hoverable" style="background-color: #1ABC9C;font-size: 14px;font-family: 'AvenirNext';">Save</a>
        </div>
        
      </div>

    </div>


    <div id="editor-division-2" class="col m8 offset-m4" style="background-color: #292F35;">
      <div>
        <div class="row" style="margin-left: auto;margin-right: auto;">
          <div class="col s12 center" style="padding-left: 0em;padding-right: 0em;">
            <br>
            <a class="btn custom-bc2" href="/flyer-dashboard" title="Home" style="position:absolute;text-transform: none;margin-left: 0em;"><i class="material-icons">home</i></a>
            <a id="add-grid-item-btn" class="btn custom-bc2" title="Add Grid Item" style="position:absolute;text-transform: none;margin-left: 4em;"><i class="material-icons">add</i></a>
            <a id="delete-grid-item-btn" class="btn custom-bc2" title="Delete Grid Item" style="position:absolute;text-transform: none;margin-left: 8em;"><i class="material-icons">delete</i></a>
            <a id="refresh-template-btn" class="btn custom-bc2" title="Reset Template" style="position:absolute;text-transform: none;margin-left: 12em;"><i class="material-icons">refresh</i></a>
            <a id="hide-cursor-btn" cursor-status="on" class="btn custom-bc2" title="Hide cursor" style="position:absolute;text-transform: none;margin-left: 16em;"><i class="material-icons">center_focus_strong</i></a>
            <a id="increase-height-btn" class="btn custom-bc2" title="Increase Height" style="position:absolute;text-transform: none;margin-left: 20em;"><i class="material-icons">keyboard_arrow_up</i></a>
            <a id="decrease-height-btn" class="btn custom-bc2" title="Decrease Height" style="position:absolute;text-transform: none;margin-left: 24em;"><i class="material-icons">keyboard_arrow_down</i></a>

            <a id="download-flyer-btn" class="btn hoverable" style="width:10em;text-align: left;text-transform: none;margin-left: 172mm;position: relative;background-color:#1ABC9C">Download<i class="material-icons right">file_download</i>
              <div id="loader-div" class="preloader-wrapper small active" style = "display:none;position: absolute;left: -50px; top: 0px;">
                <div class="spinner-layer spinner-green-only">
                  <div class="circle-clipper left">
                    <div class="circle"></div>
                  </div><div class="gap-patch">
                    <div class="circle"></div>
                  </div><div class="circle-clipper right">
                    <div class="circle"></div>
                  </div>
                </div>
              </div>
            </a>
          </div>
        </div>


        <div>
          <p id="mode-label-top" style="color: silver;"></p>
        </div>
        
        <hr style="border-bottom: 1px dashed silver;opacity: .3;margin:0;">
        
        <div id="flyer-div" class="row white" style="text-align: center;margin-left: auto;margin-right: auto; height: 297mm;width: 210mm;margin-bottom: 0em;padding-top: 1em;">
          <div id="flyer-grid" class="col s12" style="width: 210mm;">
            <div id="grid-stack-div" class="grid-stack primary-grid-stack" data-gs-width="24" data-gs-animate="yes" data-gs-column="24">

            </div>
          </div>
        </div>
        
        <hr style="border-bottom: 1px dashed silver;opacity: .3;margin:0">
        
        <div>
          <p id="mode-label-bottom" style="color: silver;"></p>
        </div>
      </div>
    </div>



<div id="upload-image-modal" class="modal">
  <div class="modal-content">
    <h4 style="font-family:'AvenirNext';font-size:18px;">Upload Image</h4>
    <div class="file-field input-field">
      <div class="btn" style = "background-color: #512da8">
        <span style="font-size:14px;">File</span>
        <input id="product-image-input" type="file" multiple>
      </div>
      <div class="file-path-wrapper">
        <input class="file-path validate" type="text">
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <a href="#!" class="modal-close waves-effect waves-green btn-flat">Cancel</a>
    <a id="upload-image-btn" href="#!" class="waves-effect waves-green btn-flat blue white-text" style="background-color:#009051 !important ;">Upload</a>
    <div class="progress" id = "upload-preloader" style = "display:none;margin: 0px !important;background-color: white !important;">
      <div class="indeterminate" style = "background-color: #512de8;"></div>
    </div>
  </div>
</div>


<div id="add-new-bg-modal" class="modal">
  <div class="modal-content">
    <h5 style="font-family: 'AvenirNext';font-size: 18px">NEW BACKGROUND IMAGE</h5>
    <br>
    <div class="row">
      
      <div class="file-field input-field col s10">
        <div class="btn" style="background-color: #1ABC9C;">
          <span>File</span>
          <input id="new-bg-image" type="file">
        </div>
        <div class="file-path-wrapper">
          <input class="file-path validate" type="text">
        </div>
      </div>

    </div>
  </div>
  <div class="modal-footer">
    <a href="#!" class="modal-close waves-effect btn-flat">Cancel</a>
    <a id="upload-new-bg-image-btn" href="#!" class="waves-effect btn-flat white-text" style="background-color: #1ABC9C;">Save</a>
  </div>
</div>




<div id="add-new-tag-modal" class="modal">
  <div class="modal-content">
    <h5 style="font-family: 'AvenirNext';font-size: 18px">NEW TAG IMAGE</h5>
    <br>
    <div class="row">
      
      <div class="file-field input-field col s10">
        <div class="btn" style="background-color: #1ABC9C;">
          <span>File</span>
          <input id="tag-image" type="file">
        </div>
        <div class="file-path-wrapper">
          <input class="file-path validate" type="text">
        </div>
      </div>

    </div>
  </div>
  <div class="modal-footer">
    <a href="#!" class="modal-close waves-effect btn-flat">Cancel</a>
    <a id="upload-flyer-tag-btn" href="#!" class="waves-effect btn-flat white-text" style="background-color: #1ABC9C;">Upload</a>
  </div>
</div>




<div id="add-new-price-tag-modal" class="modal">
  <div class="modal-content">
    <h5 style="font-family: 'AvenirNext';font-size: 18px">NEW PRICE TAG IMAGE</h5>
    <br>
    <div class="row">
      
      <div class="file-field input-field col s10">
        <div class="btn" style="background-color: #1ABC9C;">
          <span>File</span>
          <input id="price-tag-image" type="file">
        </div>
        <div class="file-path-wrapper">
          <input class="file-path validate" type="text">
        </div>
      </div>

    </div>
  </div>
  <div class="modal-footer">
    <a href="#!" class="modal-close waves-effect btn-flat">Cancel</a>
    <a id="upload-flyer-price-tag-btn" href="#!" class="waves-effect btn-flat white-text" style="background-color: #1ABC9C;">Upload</a>
  </div>
</div>



<script type="text/javascript" src="{% static 'WAMSApp/js/canvas2image.js' %}"></script>
<script type="text/javascript" src="{% static 'WAMSApp/js/html2canvas.min2.js' %}"></script>

<script type="text/javascript">

    M.AutoInit();

    var global_product_bucket_list = [];
    var global_selected_product_pk = "";
    var global_selected_product_name = "";
    var global_product_images_dict = {};
    var global_template_data = {};
    var global_background_images_bucket = [];
    var global_external_image_bucket = [];
    var global_tag_bucket = [];
    var global_price_tag_bucket = [];

    var global_flyer_name = "flyer";

    var global_save_signal = false;

    var global_primary_grid = "";

    var active_grid_id = "";
    var grid_active = "PRIMARY";

    var global_grid_store = {};
    var global_grid_cnt = 0;



    function getCsrfToken() {
      var CSRF_TOKEN = $('input[name="csrfmiddlewaretoken"]').val();
      return CSRF_TOKEN;
    }


    // ------------------ Grid Stack Logic START ------------------


    function initialize_grid()
    {
      global_primary_grid = GridStack.init({
        animate: true,
        verticalMargin: 6,
        column: 24,
        cellHeight: 10,
        resizable: {
          handles: 'e, se, s, sw, w, n'
        },
        float:true
      }, '.primary-grid-stack');
    }


    function create_unit_tag_html(tag_dict)
    {
      var image_url = tag_dict["image-url"];
      var grid_id = tag_dict["grid-id"];
      var rotation = tag_dict["rotation"];
      var image_pk = tag_dict["image-pk"];

      var html_string = `
        <div class="grid-stack-item secondary-grid-stack-item" data-gs-x="0" data-gs-y="0" data-gs-width="5" data-gs-height="3" style="background-color: transparent;" grid-id="`+grid_id+`">
          <div grid-image-pk="`+image_pk+`" gridid="`+grid_id+`" class="grid-stack-item-content secondary-grid-stack-item-content secondary-grid-stack-item-tag-content" is-price-tag=false price=0 top=0 left=0 font-size=0 style="overflow:hidden;transform:rotate(`+rotation+`deg)">
            <img class="secondary-grid-stack-item-content-img" grid-image-pk="`+image_pk+`" gridid="`+grid_id+`" image-rotator=0  src="`+image_url+`" style="position:absolute;top:0;left:0;z-index:-1;width:100%;" rotation=`+rotation+`>
          </div>
        </div>`

      return html_string;
    }



    function create_unit_price_tag_html(tag_dict)
    {
      var image_url = tag_dict["image-url"];
      var grid_id = tag_dict["grid-id"];
      var rotation = tag_dict["rotation"];
      var image_pk = tag_dict["image-pk"];
      var price = tag_dict["price"];
      var top = tag_dict["top"];
      var left = tag_dict["left"];
      
      var font_size = tag_dict["font-size"];
      var font_color = tag_dict["font-color"];
      var font_family = tag_dict["font-family"];
      var bold = tag_dict["bold"];
      var underlined = tag_dict["underlined"];
      var italic = tag_dict["italic"];
      var font_alignment = tag_dict["font-alignment"];

      var html_string = `
        <div class="grid-stack-item secondary-grid-stack-item" data-gs-x="0" data-gs-y="0" data-gs-width="5" data-gs-height="3" style="background-color: transparent;" grid-id="`+grid_id+`">
          <div grid-image-pk="`+image_pk+`" gridid="`+grid_id+`" class="grid-stack-item-content secondary-grid-stack-item-content secondary-grid-stack-item-tag-content" is-price-tag=true style="overflow:hidden;transform:rotate(`+rotation+`deg)">
            <img class="secondary-grid-stack-item-content-img" grid-image-pk="`+image_pk+`" gridid="`+grid_id+`" image-rotator=0  src="`+image_url+`" style="position:absolute;top:0;left:0;z-index:-1;width:100%;" rotation=`+rotation+`>
            <div price-id="`+grid_id+`" font-controller-id=`+grid_id+` font-controller-type=price class="price-tag-input font-controller" style="font-size:`+font_size+`px;position:absolute;top:`+top+`%;left:`+left+`%;" contenteditable onclick='$(this).focus();' price=`+price+` top=`+top+` left=`+left+` font-size=`+font_size+`>`+price+`</div>
          </div>
        </div>`

      return html_string;
    }


    function create_unit_info_container_html(tag_dict)
    {
      var grid_id = tag_dict["grid-id"];


      var html_string = `
        <div class="grid-stack-item secondary-grid-stack-item" data-gs-x="3" data-gs-y="6" data-gs-width="18" data-gs-height="5" grid-id="`+grid_id+`">
          <div gridid="`+grid_id+`" class="grid-stack-item-content secondary-grid-stack-item-content" style="overflow:hidden;">
            <div class="row" style="margin: 0em;padding:0em;">
              <div class="col s10" style="margin-bottom: 0em;">
                <textarea font-controller-id=`+grid_id+` font-controller-type=info text-grid-id="`+grid_id+`" class="materialize-textarea left secondary-grid-stack-item-content-info font-controller" placeholder="product name" style="height: 30px;border:0em;box-shadow: none;margin-bottom:0em;" bold=false underlined=false italic=false></textarea>
              </div>
            </div>
          </div>
        </div>`

      return html_string;
    }


    function create_unit_flyer_html(flyer_dict)
    {
      var grid_id = flyer_dict["grid-id"];
      var image_url = flyer_dict["image-url"];
      var image_resizer = flyer_dict["image-resizer"];
      var image_rotator = flyer_dict["image-rotator"];
      var top = flyer_dict["top"];
      var left = flyer_dict["left"];

      var html_string = `
        <div class="grid-stack-item primary-grid-stack-item" data-gs-width="10" data-gs-height="20" grid-id="`+grid_id+`">
          <div gridid="`+grid_id+`" class="grid-stack-item-content primary-grid-stack-item-content" style="border:2px solid `+global_border_color+`;overflow: hidden;">
            <div id="secondary-grid-stack-`+grid_id+`" class="grid-stack secondary-grid-stack" data-gs-width="24" data-gs-animate="yes" data-gs-column="24">
            </div>
            <img class="primary-grid-stack-item-content-img" gridid="`+grid_id+`" image-resizer=`+image_resizer+` image-rotator=`+image_rotator+` top=`+top+` left=`+left+` src="`+image_url+`" style="width:`+image_resizer+`%;position:absolute;top:`+top+`%;left:`+left+`%;z-index:-10;transform:rotate(`+image_rotator+`deg)">
          </div>
        </div>`

      return html_string;
    }


    function add_primary_grid_item()
    {
      global_grid_cnt += 1;

      var flyer_dict = {
        "grid-id": global_grid_cnt,
        "image-url": "",
        "image-resizer": "50",
        "image-rotator": "0",
        "top": "25",
        "left": "25"
      };

      var html_string = create_unit_flyer_html(flyer_dict);

      var el = $(html_string);
      global_primary_grid.addWidget(el, 0, 0, 8, 20, true);

      secondary_grid = GridStack.init({
        animate: true,
        verticalMargin: 6,
        column: 24,
        cellHeight: 10,
        resizable: {
          handles: 'e, se, s, sw, w, n'
        },
        float:true
      }, '#secondary-grid-stack-'+global_grid_cnt);

      global_grid_store[global_grid_cnt] = {
        "grid": secondary_grid,
        "grid-cnt": 1
      };

      flyer_dict = {}
      flyer_dict["grid-id"] = global_grid_cnt+"-1";
      html_string = create_unit_info_container_html(flyer_dict);
      el = $(html_string);
      secondary_grid.addWidget(el, 0, 15, 18, 4, false);

      set_border_style();
      select_primary_cell(global_grid_cnt);
    }


    function add_tag_one(image_url, image_pk)
    {
      if(grid_active=="SECONDARY")
        return;

      global_grid_store[active_grid_id]["grid-cnt"]++;

      var flyer_dict = {};
      flyer_dict["image-url"] = image_url;
      flyer_dict["image-pk"] = image_pk;

      flyer_dict["grid-id"] = active_grid_id+"-"+global_grid_store[active_grid_id]["grid-cnt"];
      flyer_dict["rotation"] = "0";
      var html_string = create_unit_tag_html(flyer_dict);

      var secondary_grid = global_grid_store[active_grid_id]["grid"];

      var el = $(html_string);
      secondary_grid.addWidget(el, 0, 0, 5, 5, true);
    }


    function add_tag_all(image_url, image_pk)
    {
      for(key in global_grid_store)
      {
        global_grid_store[key]["grid-cnt"]++;
        
        var flyer_dict = {};
        flyer_dict["image-url"] = image_url;
        flyer_dict["image-pk"] = image_pk;
        flyer_dict["grid-id"] = key+"-"+global_grid_store[key]["grid-cnt"];
        flyer_dict["rotation"] = "0";
        
        var html_string = create_unit_tag_html(flyer_dict);
        var secondary_grid = global_grid_store[key]["grid"];
        var el = $(html_string);
        secondary_grid.addWidget(el, 0, 0, 5, 5, true);
      }
    }



    function add_price_tag_one(image_url, image_pk)
    {
      if(grid_active=="SECONDARY")
        return;

      global_grid_store[active_grid_id]["grid-cnt"]++;

      var flyer_dict = {};
      flyer_dict["image-url"] = image_url;
      flyer_dict["image-pk"] = image_pk;

      flyer_dict["grid-id"] = active_grid_id+"-"+global_grid_store[active_grid_id]["grid-cnt"];
      flyer_dict["rotation"] = "0";
      flyer_dict["price"] = "Price";
      flyer_dict["top"] = "50";
      flyer_dict["left"] = "50";
      flyer_dict["font-size"] = "12";
      var html_string = create_unit_price_tag_html(flyer_dict);

      var secondary_grid = global_grid_store[active_grid_id]["grid"];

      var el = $(html_string);
      secondary_grid.addWidget(el, 0, 0, 5, 5, true);
    }


    function add_price_tag_all(image_url, image_pk)
    {
      for(key in global_grid_store)
      {
        global_grid_store[key]["grid-cnt"]++;
        
        var flyer_dict = {};
        flyer_dict["image-url"] = image_url;
        flyer_dict["image-pk"] = image_pk;
        flyer_dict["grid-id"] = key+"-"+global_grid_store[key]["grid-cnt"];
        flyer_dict["rotation"] = "0";
        flyer_dict["price"] = "Price";

        flyer_dict["top"] = "50";
        flyer_dict["left"] = "50";
        flyer_dict["font-size"] = "12";

        var html_string = create_unit_price_tag_html(flyer_dict);
        var secondary_grid = global_grid_store[key]["grid"];
        var el = $(html_string);
        secondary_grid.addWidget(el, 0, 0, 5, 5, true);
      }
    }


    function delete_grid_item()
    {
      if(grid_active=="PRIMARY")
      {
        var el =  $(".grid-stack-item[grid-id="+active_grid_id+"]");
        global_primary_grid.removeWidget(el);
      }
      else if(grid_active=="SECONDARY")
      {
        var el =  $(".grid-stack-item[grid-id="+active_grid_id+"]");
        var parent_grid_id = active_grid_id.split("-")[0];
        secondary_grid = global_grid_store[parent_grid_id]["grid"];
        secondary_grid.removeWidget(el);
      }
    }

    function delete_tag_all(image_pk)
    {
      var nodes = $("div[grid-image-pk="+image_pk+"]");
      for(var i=0;i<nodes.length;i++)
      {
        var grid_id = $(nodes[i]).attr("gridid");

        var el =  $(".grid-stack-item[grid-id="+grid_id+"]");
        var parent_grid_id = grid_id.split("-")[0];
        secondary_grid = global_grid_store[parent_grid_id]["grid"];
        secondary_grid.removeWidget(el);
      }
    }


    function select_primary_cell(grid_id)
    {
      grid_active = "PRIMARY";

      set_border_style();

      $(".primary-grid-stack-item-content[gridid="+grid_id+"]").css("border", "3px dotted "+global_border_color);

      var image_resizer = $("img[gridid="+grid_id+"]").attr("image-resizer");
      $("#image-resizer").val(image_resizer);

      var image_rotator = $("img[gridid="+grid_id+"]").attr("image-rotator");
      $("#image-rotator").val(image_rotator);

      active_grid_id = grid_id;
    }

    function select_secondary_cell(grid_id)
    {
      grid_active = "SECONDARY";

      set_border_style();

      $(".secondary-grid-stack-item-content[gridid="+grid_id+"]").css("border", "3px dotted "+global_border_color);

      var image_rotator = $("img[gridid="+grid_id+"]").attr("image-rotator");
      $("#image-rotator").val(image_rotator);

      active_grid_id = grid_id;
    }

    $(document).on("click", ".primary-grid-stack-item-content", function(e){

      if(e.target.classList.contains("secondary-grid-stack-item-content") || e.target.classList.contains("secondary-grid-stack-item-content-img") || e.target.classList.contains("materialize-textarea"))
        return;

      active_grid_id = $(this).attr("gridid");
      select_primary_cell(active_grid_id);
    });


    $(document).on("click", ".secondary-grid-stack-item-content-img", function(){
      active_grid_id = $(this).attr("gridid");
      select_secondary_cell(active_grid_id);
    });

    $(document).on("click", ".secondary-grid-stack-item-content", function(){
      active_grid_id = $(this).attr("gridid");
      select_secondary_cell(active_grid_id);
    });

    initialize_grid();


    function create_flyer()
    {
      var flyer_details = global_template_data["flyerDetails"];
      global_grid_cnt = 0;

      for(var i=0;i<flyer_details.length;i++)
      {
        global_grid_cnt = flyer_details[i]["container-id"];

        var flyer_dict ={
          "grid-id": flyer_details[i]["container-id"],
          "image-url": flyer_details[i]["data"]["image-url"],
          "image-resizer": flyer_details[i]["data"]["zoom"],
          "image-rotator": flyer_details[i]["data"]["rotation"],
          "top": flyer_details[i]["data"]["top"],
          "left": flyer_details[i]["data"]["left"]
        }
        var html_string = create_unit_flyer_html(flyer_dict);

        var container = flyer_details[i]["container"];

        var el = $(html_string);
        global_primary_grid.addWidget(el, container["x"], container["y"], container["width"], container["height"], false);

        secondary_grid = GridStack.init({
          animate: true,
          verticalMargin: 6,
          column: 24,
          cellHeight: 10,
          resizable: {
            handles: 'e, se, s, sw, w, n'
          },
          float:true
        }, '#secondary-grid-stack-'+flyer_details[i]["container-id"]);


        var info_container = flyer_details[i]["info-container"];
        flyer_dict = {
          "grid-id": info_container["container-id"]
        }
        html_string = create_unit_info_container_html(flyer_dict);
        el = $(html_string);
        secondary_grid.addWidget(el, info_container["container"]["x"], info_container["container"]["y"], info_container["container"]["width"], info_container["container"]["height"], false);

        $("textarea[text-grid-id="+info_container['container-id']+"]").html(info_container["product-info"]);
        $("textarea[text-grid-id="+info_container['container-id']+"]").css("color", info_container["font-color"]);
        $("textarea[text-grid-id="+info_container['container-id']+"]").css("font-size", info_container["font-size"]);
        $("textarea[text-grid-id="+info_container['container-id']+"]").css("font-family", info_container["font-family"]);
        $("textarea[text-grid-id="+info_container['container-id']+"]").css("font-weight", info_container["bold"]);
        $("textarea[text-grid-id="+info_container['container-id']+"]").css("text-decoration", info_container["underlined"]);
        $("textarea[text-grid-id="+info_container['container-id']+"]").css("font-style", info_container["italic"]);
        $("textarea[text-grid-id="+info_container['container-id']+"]").css("text-align", info_container["font-alignment"]);


        select_primary_cell(flyer_details[i]["container-id"]);

        var tags = flyer_details[i]["tags"];
        tag_count = 1;
        for(var j=0;j<tags.length;j++)
        {

          var flyer_dict = {
            "image-url": tags[j]["data"]["image-url"],
            "image-pk": tags[j]["data"]["image-pk"],
            "rotation": tags[j]["data"]["rotation"],
            "grid-id": tags[j]["container-id"]
          };
          
          var html_string = "";
          if(tags[j]["data"]["is-price-tag"]=="true")
          {
            var price = tags[j]["data"]["price"];

            flyer_dict["price"] = price["price"];
            flyer_dict["top"] = price["top"];
            flyer_dict["left"] = price["left"];
            flyer_dict["font-size"] = price["font-size"];
            flyer_dict["font-color"] = price["font-color"];
            flyer_dict["font-family"] = price["font-family"];
            flyer_dict["bold"] = price["bold"];
            flyer_dict["underlined"] = price["underlined"];
            flyer_dict["italic"] = price["italic"];
            flyer_dict["font-alignment"] = price["font-alignment"];

            html_string = create_unit_price_tag_html(flyer_dict); 
          }
          else
          {
            html_string = create_unit_tag_html(flyer_dict);
          }

          
          el = $(html_string);
          secondary_grid.addWidget(el, tags[j]["container"]["x"], tags[j]["container"]["y"], tags[j]["container"]["width"], tags[j]["container"]["height"], false);

          tag_count = tags[j]["container-id"];
        }

        global_grid_store[flyer_details[i]["container-id"]] = {
          "grid": secondary_grid,
          "grid-cnt": tag_count
        };
      }

      if(global_background_image_url!="none")
      {
        $("#flyer-div").css("background-image", "url("+global_background_image_url+")");
        $("#flyer-div").css("background-position", "center");
      }

    }

    // ------------------ Grid Stack Logic END ------------------












    // ------------------ Editor Trigger Logic START ------------------

    function price_or_info()
    {
      if(active_grid_id.substr(-2)=="-1")
        return "INFO";
      return "PRICE";
    }

    $(document).on("change", "#font-size", function(){
      var font_size = $("#font-size").val();
      if($("#font-multi-option").prop("checked"))
      {
        if(price_or_info()=="INFO")
        {
          $("textarea").css("font-size", font_size+"px"); 
        }
        else if(price_or_info()=="PRICE")
        {
          $(".price-tag-input").css("font-size", font_size+"px");
          font_size = font_size/1.6;
        $(".price-tag-small-input").css("font-size", font_size+"px");
        }
      }
      else
      {
        $(".font-controller[font-controller-id="+active_grid_id+"]").css("font-size", font_size+"px");
      }
    });

    $(document).on("change", "#font-family", function(){
      var font_family = $("#font-family").val();
      if($("#font-multi-option").prop("checked"))
      {
        if(price_or_info()=="INFO")
        {
          $("textarea").css("font-family", font_family); 
        }
        else if(price_or_info()=="PRICE")
        {
          $(".price-tag-input").css("font-family", font_family);
        }
      }
      else
      {
        $(".font-controller[font-controller-id="+active_grid_id+"]").css("font-family", font_family);
      }
    });

    $(document).on("click", "#format-bold-btn", function(){
      var val = "";
      if($(this).attr("bold")=="true")
      {
        $(this).attr("bold", "false")
        val = "normal";
      }
      else
      {
        $(this).attr("bold", "true")
        val = "bolder"; 
      }
      if($("#font-multi-option").prop("checked"))
      {
        if(price_or_info()=="INFO")
          $("textarea").css("font-weight", val); 
        else if(price_or_info()=="PRICE")
          $(".price-tag-input").css("font-weight", val);
      }
      else
      {
        $(".font-controller[font-controller-id="+active_grid_id+"]").css("font-weight", val);
      }
    });

    $(document).on("click", "#format-underlined-btn", function(){
      var val = "";
      if($(this).attr("underlined")=="true")
      {
        $(this).attr("underlined", "false")
        val = "none";
      }
      else
      {
        $(this).attr("underlined", "true")
        val = "underline"; 
      }
      if($("#font-multi-option").prop("checked"))
      {
        if(price_or_info()=="INFO")
          $("textarea").css("text-decoration", val);
        else if(price_or_info()=="PRICE")
          $(".price-tag-input").css("text-decoration", val);
      }
      else
      {
        $(".font-controller[font-controller-id="+active_grid_id+"]").css("text-decoration", val);
      }
    });

    $(document).on("click", "#format-italic-btn", function(){
      var val = "";
      if($(this).attr("italic")=="true")
      {
        $(this).attr("italic", "false")
        val = "normal";
      }
      else
      {
        $(this).attr("italic", "true")
        val = "italic"; 
      }
      if($("#font-multi-option").prop("checked"))
      {
        if(price_or_info()=="INFO")
          $("textarea").css("font-style", val);
        else if(price_or_info()=="PRICE")
          $(".price-tag-input").css("font-style", val);
      }
      else
      {
        $(".font-controller[font-controller-id="+active_grid_id+"]").css("font-style", val);
      }
    });

    $(document).on("click", ".font-alignment", function(){
      var font_alignment = $(this).attr("value");
      if($("#font-multi-option").prop("checked"))
      {
        if(price_or_info()=="INFO")
          $("textarea").css("text-align", font_alignment);
        else if(price_or_info()=="PRICE")
          $(".price-tag-input").css("text-align", font_alignment); 
      }
      else
      {
        $(".font-controller[font-controller-id="+active_grid_id+"]").css("text-align", font_alignment);
      }
    });

    $(document).on("change", "#font-color", function(){
      var color = $("#font-color").val();
      if($("#font-multi-option").prop("checked"))
      {
        if(price_or_info()=="INFO")
          $("textarea").css("color", color); 
        else if(price_or_info()=="PRICE")
          $(".price-tag-input").css("color", color);
      }
      else
      {
        $(".font-controller[font-controller-id="+active_grid_id+"]").css("color", color);
      }
    });


    $(document).on("change", "#border-option", function(){
      if($("#border-option").prop("checked"))
        global_border_visible  = true;
      else
        global_border_visible  = false;
      set_border_style();
    });

    $(document).on("change", "#border-color", function(){
      if($("#border-option").prop("checked"))
      {
        global_border_color = $("#border-color").val();
      }
      set_border_style();
    });


    $("#image-resizer").change(function() {

      if(grid_active=="SECONDARY")
        return;

      var R = $("#image-resizer").val();

      $("img[gridid="+active_grid_id+"]").css("width", R+"%");
      $("img[gridid="+active_grid_id+"]").attr("image-resizer", R);
    });

    $("#all-image-resizer").change(function() {
      var R = $("#all-image-resizer").val();

      $("#image-resizer").val(R);

      $(".primary-grid-stack-item-content-img").css("width", R+"%");
      $(".primary-grid-stack-item-content-img").attr("image-resizer", R);
      
    });

    $("#image-rotator").change(function() {
      
      var R = $("#image-rotator").val();

      if(grid_active=="PRIMARY")
      {
        $("img[gridid="+active_grid_id+"]").css("transform", "rotate("+R+"deg)");
      }
      else
      {
        $(".secondary-grid-stack-item-tag-content[gridid="+active_grid_id+"]").css("transform", "rotate("+R+"deg)");
      }
      $("img[gridid="+active_grid_id+"]").attr("image-rotator", R);
    });

    $("#all-image-rotator").change(function() {

      var R = $("#all-image-rotator").val();
      $("#image-rotator").val(R);

      $(".primary-grid-stack-item-content-img").css("transform", "rotate("+R+"deg)");
      $(".primary-grid-stack-item-content-img").attr("image-rotator", R);
    
      $(".secondary-grid-stack-item-tag-content").css("transform", "rotate("+R+"deg)");
      $(".secondary-grid-stack-item-content-img").attr("image-rotator", R);
    });

    $(document).on('click', '.imgselect', function(){
        if(grid_active=="SECONDARY")
          return;
        var image_pk = this.id.split("_")[1];
        var image_url = $($(this).children()[0]).attr("high-res-url");
        $("img[gridid="+active_grid_id+"]").attr("src", image_url);
        $("textarea[text-grid-id="+active_grid_id+"-1]").html(global_selected_product_name);
    });


    $(document).on('click', '.bgimgselect', function(){
        var image_pk = this.id.split("_")[1];
        var image_url = $(this).children()[0].src
        global_background_image_url = image_url;

        $("#flyer-div").css("background-image", "url("+image_url+")");
        $("#flyer-div").css("background-position", "center");
    });


    $(document).on('click', '.tagimgselect', function(){

        var image_url = $(this).children()[0].src;
        var image_pk = $(this).attr("image-pk");

        if($("#tag-delete-option").prop("checked"))
        {
          delete_tag_all(image_pk);
        }
        else if($("#tag-multi-option").prop("checked")==false)
        {
          add_tag_one(image_url, image_pk);
        }
        else
        {
          add_tag_all(image_url, image_pk);
        }
    });



    $(document).on('click', '.pricetagimgselect', function(){

        var image_url = $(this).children()[0].src;
        var image_pk = $(this).attr("image-pk");

        if($("#price-tag-delete-option").prop("checked"))
        {
          delete_tag_all(image_pk);
        }
        else if($("#price-tag-multi-option").prop("checked")==false)
        {
          add_price_tag_one(image_url, image_pk);
        }
        else
        {
          add_price_tag_all(image_url, image_pk);
        }
    });



    $(document).on('click', '.product-basket-card-btn', function(){
      
      $(".product-basket-border-div").css("border", "2px solid #495561")
      $(this).children()[0].style.border = "2px solid #1ABC9C";

      global_selected_product_pk = this.id.split("_")[1];
      global_selected_product_name = $("#product-basket-card-name-"+global_selected_product_pk).attr("title");

      update_image_categories("all_images");
    });

    // ------------------ Editor Trigger Logic END ------------------









    // ------------------ Editor Update Logic START ------------------

    function add_to_product_basket()
    {
      var product_name = $("#autocomplete-input").val();

      $.ajax({
        url: "/add-product-flyer-bucket/",
        type: "POST",
        headers:{
          'X-CSRFToken':getCsrfToken()
        },
        data: {
          product_name: product_name,
          flyer_pk: window.location.pathname.split("/")[2]
        },
        success: function(response) {
          console.log("Success!", response);
          if(response["status"]==200)
          {
            global_product_bucket_list.push({"product_bucket_pk": response["product_pk"], "product_bucket_name":response["product_name"], "product_bucket_image_url": response["product_image_url"], "seller_sku": response["seller_sku"]});
            global_product_images_dict[response["product_pk"]] = response["images"];
            set_product_basket();
          }
          else if(response["status"]==403)
          {
            M.toast({html: "You do not have permission to add products to flyer bucket!"});
          }
          else
          {
            M.toast({html: "Error adding product to flyer bucket!"}); 
          }
        },
        error: function(xhr, textstatus, errorthrown) {
          console.log("Please report this error: "+errorthrown+xhr.status+xhr.responseText);
        }
      });


      $("#autocomplete-input").val("");
    }

    function fetch_product_list_autocomplete()
    {
      $.ajax({
        url: "/fetch-product-list-flyer-pfl/",
        type: "POST",
        headers:{
          'X-CSRFToken':getCsrfToken()
        },
        data: {
          "flyer_pk": window.location.pathname.split("/")[2],
          "search_string": $("#autocomplete-input").val()
        },
        success: function(response) {
          console.log("Success!", response);

          var autocomplete_data = {};
          var product_list = response["product_list"];
          for(var i=0;i<product_list.length;i++)
          {
            autocomplete_data[product_list[i]["product_name_autocomplete"]] = product_list[i]["main_image_url"]; 
          }

          var el = document.getElementById("autocomplete-input");
          var options = {
            data: autocomplete_data,
            minLength: 3,
            limit: 50,
            onAutocomplete: function()
            {
              add_to_product_basket();
            }
          }

          var instance = M.Autocomplete.init(el, options);
          instance.open();
        },
        error: function(xhr, textstatus, errorthrown) {
          console.log("Please report this error: "+errorthrown+xhr.status+xhr.responseText);
        }
      });
    }

    var autocomplete_timer_id;
    $("#autocomplete-input").keyup(function() {
      clearTimeout(autocomplete_timer_id);
      autocomplete_timer_id = setTimeout(function(){
        fetch_product_list_autocomplete();
      }, 500);
    });


    function set_product_basket()
    {
      //Product Basket needs to be updated
      var html_string = "";
      for(var i=0;i<global_product_bucket_list.length;i++)
      {
        var short_product_name = global_product_bucket_list[i]["product_bucket_name"];
        var char_length = 50;
        if(short_product_name.length>char_length)
        {
          short_product_name = short_product_name.substring(0, char_length) + "...";
        }

        html_string += `
          <a href="#!" class="product-basket-card-btn" id="basket_`+global_product_bucket_list[i]["product_bucket_pk"]+`">
            <div class="product-basket-border-div row" style="border: 2px solid #495561;margin-right:0em;">
              <div class="col s4" style="padding-left:0em;margin-right:0em;padding-right:0em;">
                <div class="img-box" style="border-right: 2px solid #495561;text-align:center;padding-top:0.5em;">
                  <img src="`+global_product_bucket_list[i]["product_bucket_image_url"]+`" style="width:80%;max-height:5em;margin-left:0;object-fit: cover;object-position:center;">
                </div>
              </div>
              <div class="product-basket-card col s8">
                <div style="padding-left:0em;height:6em;">
                  <div class="custom-text2" style="padding-top:1em;font-family:'AvenirNext';" title="`+global_product_bucket_list[i]["product_bucket_name"]+`" id="product-basket-card-name-`+global_product_bucket_list[i]["product_bucket_pk"]+`">`+
                  short_product_name+`
                  </div>
                  <div style="padding-top:1em;font-family:'AvenirNextRegular';margin-top:-1em;font-size:0.8em;" class="custom-text3">`+
                  global_product_bucket_list[i]["seller_sku"]+`
                  </div>
                </div>
              </div>
            </div>
          </a>`;
      }

        $("#product-basket-list-div").html(html_string);
        $($(".product-basket-card-btn")[$(".product-basket-card-btn").length-1]).click();
    }



    function update_image_categories(key)
    {
      var html_string = "";

      var images = global_product_images_dict[global_selected_product_pk][key];
      for(var i=0;i<images.length;i++)
      {
        html_string += `<div class="col s3" style="padding-top:0.2em;margin-bottom:1.4em;">
          <div style="border:2px solid #495561;text-align:center;padding-top:0.5em;">
            <a class="imgselect" id="imgselect_`+images[i]["pk"]+`" href="#!"><img src="`+images[i]["url"]+`" style="width:90%;height:3em;object-fit:cover;" high-res-url="`+images[i]["high_res_url"]+`"></a>
          </div>
        </div>`;
      }

      $("#image-categories-thumbnails-div").html(html_string);
    }



    function update_background_image_bucket()
    {
      var html_string = "";

      var images = global_background_images_bucket;
      for(var i=0;i<images.length;i++)
      {
        html_string += `<div class="col s3" style="padding-top:0.2em;margin-bottom:1.4em;">
          <div style="border:2px solid #495561;text-align:center;padding-top:0.4em;">
            <a class="bgimgselect" id="bgimgselect_`+images[i]["pk"]+`" href="#!">
              <img src="`+images[i]["url"]+`" style="width:90%;height:3em;object-fit:cover;">
            </a>
          </div>
        </div>`;
      }

      $("#background-image-bucket-thumbnails-div").html(html_string);
    }

    function update_tag_bucket()
    {
      var html_string = "";

      var images = global_tag_bucket;
      for(var i=0;i<images.length;i++)
      {
        html_string += `<div class="col s3" style="padding-top:0.2em;margin-bottom:1.4em;">
          <div style="border:2px solid #495561;text-align:center;padding-top:0.4em;">
            <a class="tagimgselect" image-pk="`+images[i]["pk"]+`" href="#!">
              <img src="`+images[i]["url"]+`" style="width:90%;height:3em;object-fit:cover;">
            </a>
          </div>
        </div>`;
      }

      $("#tag-bucket-thumbnails-div").html(html_string);
    }


    function update_price_tag_bucket()
    {
      var html_string = "";

      var images = global_price_tag_bucket;
      for(var i=0;i<images.length;i++)
      {
        html_string += `<div class="col s3" style="padding-top:0.2em;margin-bottom:1.4em;">
          <div style="border:2px solid #495561;text-align:center;padding-top:0.4em;">
            <a class="pricetagimgselect" image-pk="`+images[i]["pk"]+`" href="#!">
              <img src="`+images[i]["url"]+`" style="width:90%;height:3em;object-fit:cover;">
            </a>
          </div>
        </div>`;
      }

      $("#price-tag-bucket-thumbnails-div").html(html_string);
    }

    function update_external_image_bucket()
    {
      var html_string = "";

      var images = global_external_image_bucket;
      for(var i=0;i<images.length;i++)
      {
        html_string += `<div class="col s3" style="padding-top:0.2em;margin-bottom:1.4em;">
          <div style="border:2px solid #495561;text-align:center;padding-top:0.4em;">
            <a class="imgselect2" href="#!">
              <img src="`+images[i]["url"]+`" high-res-url="`+images[i]["high_res_url"]+`" style="width:90%;height:3em;object-fit:cover;">
            </a>
          </div>
        </div>`;
      }

      $("#external-image-categories-thumbnails-div").html(html_string); 
    }


    // ------------------ Editor Update Logic END ------------------












    // ------------------ Top Menu Logic START ------------------


    $("#refresh-template-btn").click(function (){

      global_primary_grid.destroy();
      var html_string = `<div id="grid-stack-div" class="grid-stack primary-grid-stack" data-gs-width="24" data-gs-animate="yes" data-gs-column="24">

            </div>`
      $("#flyer-grid").html(html_string);
      global_grid_cnt = 0;
      global_background_image_url = "none";
      set_background_image();
      initialize_grid();
    });


    $("#hide-cursor-btn").click(function() {

      if($("#hide-cursor-btn").attr("cursor-status")=="on") //Make cursor invisible
      {
        $("#hide-cursor-btn").attr("cursor-status", "off");
        set_border_style();
      }
      else  //Make cursor visible
      {
        $("#hide-cursor-btn").attr("cursor-status", "on");
        set_border_style();
        if(grid_active=="PRIMARY")
          $(".primary-grid-stack-item-content[gridid="+active_grid_id+"]").css("border", "3px dotted "+global_border_color);
        else
          $(".secondary-grid-stack-item-content[gridid="+active_grid_id+"]").css("border", "3px dotted "+global_border_color);
      }
    });


    $("#increase-height-btn").click(function(){
      var grid_items = $(".primary-grid-stack-item");
      for(var i=0;i<grid_items.length;i++)
      {
        var old_height = $(grid_items[i]).attr("data-gs-height");
        var old_width = $(grid_items[i]).attr("data-gs-width");
        var new_height = parseInt(old_height)+1;

        el = $(grid_items[i]);
        global_primary_grid.resize(el, old_width, new_height);
      }
    });

    $("#decrease-height-btn").click(function(){
      var grid_items = $(".primary-grid-stack-item");
      for(var i=0;i<grid_items.length;i++)
      {
        var old_height = $(grid_items[i]).attr("data-gs-height");
        var old_width = $(grid_items[i]).attr("data-gs-width");
        var new_height = parseInt(old_height)-1;

        el = $(grid_items[i]);
        global_primary_grid.resize(el, old_width, new_height);
      }
    });    



    $("#add-grid-item-btn").click(function(){
      add_primary_grid_item();
    });


    $("#delete-grid-item-btn").click(function(){
      delete_grid_item();
    })

    // ------------------ Top Menu Logic END ------------------







    // ------------------ Price Tag START ------------------

    function set_split(price, font_size)
    {
      if(price=="")
        return "Price";

      if(price.includes(".")==false)
        return price;
      
      var value = price.split(".");
      font_size = parseInt(font_size)/1.6;
      var html_string = value[0]+".<span class='price-tag-small-input' style='font-size:"+font_size+"px'>"+value[1]+"</span>";
      return html_string;
    }

    $(document).on("focusout", ".price-tag-input", function(){

        var price = $(this).text();
        $(this).attr("price", price);

        var font_size = $(this).css("font-size").replace("px", "")
        var html_string = set_split(price, font_size);
        $(this).html(html_string);
    });

    $(document).on("keydown", ".price-tag-input", function(e){
        if(e.keyCode==13)
        {
          e.preventDefault();
          $(this).focusout();
        }
    });

    

    // ------------------ Price Tag END ------------------










    // ------------------ Upload Logic Start ------------------



    $("#upload-new-bg-image-btn").click(function(){

      var fd = new FormData();
      var bg_image = document.getElementById("new-bg-image"); 
      fd.append('bg_image', bg_image.files[0]);
      fd.append('flyer_pk', window.location.pathname.split("/")[2])

      $.ajax({
        url: "/upload-new-flyer-bg-image/",
        type: "POST",
        headers:{
          'X-CSRFToken':getCsrfToken()
        },
        processData: false,
        contentType: false,
        data: fd,
        success: function(response) {
          console.log("Success!", response);
          if(response["status"]==200)
          {
            global_background_images_bucket.push({"pk":response["bg_image_pk"], "url":response["bg_image_url"]});
            update_background_image_bucket();
            $("#add-new-bg-modal").modal("close");
          }
          else if(response["status"]==403)
          {
            M.toast({html: "You do not have permission to add background images!"});
          }
          else
          {
            M.toast({html: "Error adding background images!"}); 
          }
        },
        error: function(xhr, textstatus, errorthrown) {
          console.log("Please report this error: "+errorthrown+xhr.status+xhr.responseText);
        }
      });

    })



    $("#upload-flyer-tag-btn").click(function(){

      var fd = new FormData();
      var tag_image = document.getElementById("tag-image");
      fd.append('tag_image', tag_image.files[0]);

      $.ajax({
        url: "/upload-flyer-tag/",
        type: "POST",
        headers:{
          'X-CSRFToken':getCsrfToken()
        },
        processData: false,
        contentType: false,
        data: fd,
        success: function(response) {
          console.log("Success!", response);
          if(response["status"]==200)
          {
            global_tag_bucket.push({"pk":response["tag_image_pk"], "url":response["tag_image_url"]});
            update_tag_bucket();
          }
          else if(response["status"]==403)
          {
            M.toast({html: "You do not have permission to add tags!"});
          }
          else
          {
            M.toast({html: "Error adding tags!"}); 
          }
        },
        error: function(xhr, textstatus, errorthrown) {
          console.log("Please report this error: "+errorthrown+xhr.status+xhr.responseText);
        }
      });

    });






    $("#upload-flyer-price-tag-btn").click(function(){

      var fd = new FormData();
      var price_tag_image = document.getElementById("price-tag-image");
      fd.append('price_tag_image', price_tag_image.files[0]);

      $.ajax({
        url: "/upload-flyer-price-tag/",
        type: "POST",
        headers:{
          'X-CSRFToken':getCsrfToken()
        },
        processData: false,
        contentType: false,
        data: fd,
        success: function(response) {
          console.log("Success!", response);
          if(response["status"]==200)
          {
            global_price_tag_bucket.push({"pk":response["price_tag_image_pk"], "url":response["price_tag_image_url"]});
            update_price_tag_bucket();
          }
          else if(response["status"]==403)
          {
            M.toast({html: "You do not have permission to add price tags!"});
          }
          else
          {
            M.toast({html: "Error adding price tags!"}); 
          }
        },
        error: function(xhr, textstatus, errorthrown) {
          console.log("Please report this error: "+errorthrown+xhr.status+xhr.responseText);
        }
      });

    })






    $("#upload-image-btn").click(function(){

      var fd = new FormData();
      fd.append("flyer_pk", window.location.pathname.split("/")[2]);

      var product_image_input = document.getElementById("product-image-input");

      fd.append("image_count", product_image_input.files.length);
      for(var i=0;i<product_image_input.files.length;i++)
      {
        fd.append("image_"+i, product_image_input.files[i]);
      }
      $("#upload-preloader").show();
      $("#upload-image-btn").attr("disabled", "disabled");

      $.ajax({
        url: "/upload-flyer-external-images/",
        type: "POST",
        headers:{
          'X-CSRFToken':getCsrfToken()
        },
        processData: false,
        contentType: false,
        data: fd,
        success: function(response) {
          console.log("Success!", response);
          $("#upload-preloader").hide();
          $("#upload-image-btn").removeAttr("disabled");

          if(response["status"]==200)
          {
            $("#upload-image-modal").modal("close");
            M.toast({html: "Successfully uploaded images!"});

            var images = response["external_images_bucket_list"];
            for(var i=0;i<images.length;i++)
            {
              global_external_image_bucket.push({"url":images[i]["url"], "high_res_url":images[i]["high_res_url"]});
            }
            update_external_image_bucket();
          }
          else if(response["status"]==403)
          {
            M.toast({html: "You do not have permission to upload images!"});
          }
          else
          {
            M.toast({html: "Error uploading images!"});
          }
        },
        error: function(xhr, textstatus, errorthrown) {
          console.log("Please report this error: "+errorthrown+xhr.status+xhr.responseText);
          $("#upload-preloader").hide();
        }
      });
    });



    // ------------------ Upload Logic END ------------------







    // ------------------ Download Logic START ------------------

    $("#download-flyer-btn").click(function(e)
    {

      if(global_save_signal==false)
      {
        $("#download-flyer-btn").attr("disabled", "disabled");
        $("#loader-div").show();
      }


      var image_links = [];

      //Primary Grid Images
      for(var i=0;i<$(".primary-grid-stack-item-content-img").length;i++)
      {
        var grid_id = $($(".primary-grid-stack-item-content-img")[i]).attr("gridid");
        var image_url = $($(".primary-grid-stack-item-content-img")[i]).attr("src");
        if(image_url!="")
        {
          image_links.push({"key": grid_id, "url": image_url});
        }
      }

      //Secondary Grid Images
      for(var i=0;i<$(".secondary-grid-stack-item-content-img").length;i++)
      {
        var grid_id = $($(".secondary-grid-stack-item-content-img")[i]).attr("gridid");
        var image_url = $($(".secondary-grid-stack-item-content-img")[i]).attr("src");
        if(image_url!="")
        {
          image_links.push({"key": grid_id, "url": image_url});
        }
      }

      //Background Image
      if($("#flyer-div").css("background-image")!="none")
      {
        var key = "background-image";
        var url = $("#flyer-div").css("background-image").replace('url("', "").replace('")', "");
        image_links.push({"key":"background-image", "url": url});
      }


      $.ajax({
        url: "/download-images-s3/",
        type: "POST",
        headers:{
          'X-CSRFToken':getCsrfToken()
        },
        data: { 
          links : JSON.stringify(image_links)
        },
        success: function(response) {
          console.log("Success! ", response);

          if(response["status"]==200)
          {
            var local_links = response["local_links"];
            
            for(var i=0;i<local_links.length;i++)
            {
              var key = local_links[i]["key"];
              var url = local_links[i]["url"];

              if(key!="background-image")
              {
                $("img[gridid="+key+"]").attr("src", url)
              }
              else
              {
                $("#flyer-div").css("background-image", 'url("'+url+'")')
              }
            }

            e.preventDefault();

            var scale = 5;
            var div = document.getElementById('flyer-div');
            var canvas = document.createElement('canvas');
            var h = div.scrollHeight;
            var ratio = canvas.width/canvas.height;
            var w = h * ratio;
            canvas.width = scale*window.devicePixelRatio*div.scrollWidth;
            canvas.height = scale*window.devicePixelRatio*div.scrollHeight;
            canvas.style.width = w + 'px';
            canvas.style.height = h + 'px';
            var context = canvas.getContext('2d');
            context.scale(scale, scale);

            function dataURLtoBlob(dataurl) {
              var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                  bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
              while(n--){
                  u8arr[n] = bstr.charCodeAt(n);
              }
              return new Blob([u8arr], {type:mime});
            }

            window.scrollTo(0,0);
            html2canvas(div, {canvas:canvas, scrollX:-1, scrollY:0}).then(function(canvas) {
              console.log("Downloading Flyer...");
                  
              var dataURI = canvas.toDataURL("image/jpeg").replace("image/jpeg", "image/octet-stream");

              var blob = dataURLtoBlob(dataURI);
              var objurl = URL.createObjectURL(blob);
                  
              if(global_save_signal==false)
              {
                $("#download-flyer-btn").removeAttr("disabled");
                $("#loader-div").hide();
                var a = document.createElement('a');
                a.download = 'test1.jpg';
                a.href = objurl;
                a.click();
              }
              global_save_signal = false;

              //Restore original links
              for(var i=0;i<image_links.length;i++)
              {
                var key = image_links[i]["key"];
                var url = image_links[i]["url"];

                if(key!="background-image")
                {
                  $("img[gridid="+key+"]").attr("src", url)
                }
                else
                {
                  $("#flyer-div").css("background-image", 'url("'+url+'")')
                }
              }



              //Save as thumbnail
              var image_data = canvas.toDataURL("image/jpeg", 0.4);

              var fd = new FormData();
              fd.append('image_data', image_data);
              fd.append('flyer_pk', window.location.pathname.split("/")[2]);

              $.ajax({
                url: "/save-flyer-in-bucket/",
                type: "POST",
                headers:{
                  'X-CSRFToken':getCsrfToken()
                },
                processData: false,
                contentType: false,
                data: fd,
                success: function(response) {
                  console.log("Success!", response);
                },
                error: function(xhr, textstatus, errorthrown) {
                  console.log("Please report this error: "+errorthrown+xhr.status+xhr.responseText);
                }
              });
            });
          }
        },
        error: function(xhr, textstatus, errorthrown) {
          console.log("Please report this error: "+errorthrown+xhr.status+xhr.responseText);
        }
      });
    });


    $("#save-flyer-template-btn").click(function(){

      global_save_signal = true;
      $("#save-flyer-template-btn").attr("disabled", "disabled");

      $("#download-flyer-btn").click();

      var flyer_details = [];
      for(var i=0;i<$(".primary-grid-stack-item").length;i++)
      {
        var grid_id = $($(".primary-grid-stack-item")[i]).attr("grid-id");

        var tag_data = [];
        for(var j=0;j<$(".secondary-grid-stack-item-tag-content[gridid^="+grid_id+"-]").length;j++)
        {
          var base_el = $($(".secondary-grid-stack-item-tag-content[gridid^="+grid_id+"-]")[j]);
          var container_id = base_el.parent().attr("grid-id");

          var price = {};
          if(base_el.attr("is-price-tag")=="true")
          {
            price_el = $("div[price-id="+container_id+"]")
            price = {
              "price": price_el.attr("price"),
              "top": price_el.attr("top"),
              "left": price_el.attr("left"),
              "font-size": price_el.css("font-size"),
              "font-color": price_el.css("color"),
              "font-family": price_el.css("font-family"),
              "bold": price_el.css("font-weight"),
              "underlined": price_el.css("text-decoration"),
              "italic": price_el.css("font-style"),
              "font-alignment": price_el.css("text-align")
            }
            console.log("saving price ", price);
          }

          var temp_dict = {
            "container-id": container_id,
            "container": {
              "x": base_el.parent().attr("data-gs-x"),
              "y": base_el.parent().attr("data-gs-y"),
              "height": base_el.parent().attr("data-gs-height"),
              "width": base_el.parent().attr("data-gs-width")
            },
            "data": {
              "image-url": $(".secondary-grid-stack-item-content-img[gridid="+container_id+"]").attr("src"),
              "rotation": $(".secondary-grid-stack-item-content-img[gridid="+container_id+"]").attr("image-rotator"),
              "image-pk": $(".secondary-grid-stack-item-content-img[gridid="+container_id+"]").attr("grid-image-pk"),
              "is-price-tag": base_el.attr("is-price-tag"),
              "price": price
            }
          }
          tag_data.push(temp_dict);
        }

        var temp_dict = {
          "container-id": grid_id,
          "container": {
            "x": $($(".primary-grid-stack-item")[i]).attr("data-gs-x"),
            "y": $($(".primary-grid-stack-item")[i]).attr("data-gs-y"),
            "height": $($(".primary-grid-stack-item")[i]).attr("data-gs-height"),
            "width": $($(".primary-grid-stack-item")[i]).attr("data-gs-width")
          },
          "data": {
            "image-url": $(".primary-grid-stack-item-content-img[gridid="+grid_id+"]").attr("src"),
            "zoom": $(".primary-grid-stack-item-content-img[gridid="+grid_id+"]").attr("image-resizer"),
            "rotation": $(".primary-grid-stack-item-content-img[gridid="+grid_id+"]").attr("image-rotator"),
            "top": $(".primary-grid-stack-item-content-img[gridid="+grid_id+"]").attr("top"),
            "left": $(".primary-grid-stack-item-content-img[gridid="+grid_id+"]").attr("left"),
          },
          "info-container": {
              "container-id": $(".secondary-grid-stack-item-content[gridid="+grid_id+"-1]").attr("gridid"),
              "container": {
                  "x": $(".secondary-grid-stack-item-content[gridid="+grid_id+"-1]").parent().attr("data-gs-x"),
                  "y": $(".secondary-grid-stack-item-content[gridid="+grid_id+"-1]").parent().attr("data-gs-y"),
                  "height": $(".secondary-grid-stack-item-content[gridid="+grid_id+"-1]").parent().attr("data-gs-height"),
                  "width": $(".secondary-grid-stack-item-content[gridid="+grid_id+"-1]").parent().attr("data-gs-width")
              },
              "product-info": $("textarea[text-grid-id="+grid_id+"-1]").val(),
              "font-color": $("textarea[text-grid-id="+grid_id+"-1]").css("color"),
              "font-size": $("textarea[text-grid-id="+grid_id+"-1]").css("font-size"),
              "font-family": $("textarea[text-grid-id="+grid_id+"-1]").css("font-family"),
              "bold": $("textarea[text-grid-id="+grid_id+"-1]").css("font-weight"),
              "underlined": $("textarea[text-grid-id="+grid_id+"-1]").css("text-decoration"),
              "italic": $("textarea[text-grid-id="+grid_id+"-1]").css("font-style"),
              "font-alignment": $("textarea[text-grid-id="+grid_id+"-1]").css("text-align")
          },
          "tags": tag_data
        }

        flyer_details.push(temp_dict);
      }

      global_template_data = {
        "flyerDetails": flyer_details,
        "common": {
          "background-image-url": global_background_image_url,
          "border-visible": $("#border-option").prop("checked"),
          "border-color": $("#border-color").val()
        }
      }

      $.ajax({
        url: "/save-flyer-template/",
        type: "POST",
        headers:{
          'X-CSRFToken':getCsrfToken()
        },
        data: {
          flyer_pk: window.location.pathname.split("/")[2],
          template_data: JSON.stringify(global_template_data)
        },
        success: function(response) {
          console.log("Success!", response);
          $("#save-flyer-template-btn").removeAttr("disabled");
          if(response["status"]==200)
          {
            M.toast({html: "Flyer template saved successfully!"});
          }
          else if(response["status"]==403)
          {
            M.toast({html: "You do not have permission to save flyer!"}); 
          }
          else
          {
            M.toast({html: "Error saving flyer!"});
          }
        },
        error: function(xhr, textstatus, errorthrown) {
          console.log("Please report this error: "+errorthrown+xhr.status+xhr.responseText);
        }
      });

    });

    // ------------------ Download Logic END ------------------
    

    


      


    

    

    


    



    

    function fetch_flyer_details()
    {
      $.ajax({
        url: "/fetch-flyer-details/",
        type: "POST",
        headers:{
          'X-CSRFToken':getCsrfToken()
        },
        data: {
          pk: window.location.pathname.split("/")[2]
        },
        success: function(response) {
          console.log("Success!", response);

          set_canvas_mode(response["mode"]);

          global_product_bucket_list = response["product_bucket_list"];
          global_product_images_dict = response['images'];
          global_template_data = response["template_data"];
          global_background_images_bucket = response["background_images_bucket"];
          global_tag_bucket = response["tag_bucket"];
          global_price_tag_bucket = response["price_tag_bucket"]
          global_external_image_bucket = response["external_images_bucket_list"];

          global_flyer_name = response["flyer_name"];

          var common = global_template_data["common"];

          global_border_color = common["border-color"];
          global_border_visible = common["border-visible"];
          global_background_image_url = common["background-image-url"];

          set_product_basket();
          update_background_image_bucket();
          update_tag_bucket();
          update_price_tag_bucket();
          update_external_image_bucket();

          create_flyer();
        },
        error: function(xhr, textstatus, errorthrown) {
          console.log("Please report this error: "+errorthrown+xhr.status+xhr.responseText);
        }
      });
    }

    fetch_flyer_details();



    $(window).keydown(function(event) {

      if(event.keyCode==83 && event.ctrlKey)
      {
        $("#save-flyer-template-btn").click();
        event.preventDefault();
        return;
      }

      if(grid_active=="SECONDARY")
        return;

      if(document.activeElement.type=="textarea" || document.activeElement.type=="text")
        return;

      if(active_grid_id=="")
        return;

      var top = parseInt($("img[gridid="+active_grid_id+"]").attr("top"));
      var left = parseInt($("img[gridid="+active_grid_id+"]").attr("left"));
      var size = parseInt($("img[gridid="+active_grid_id+"]").attr("image-resizer"));

      var inc = 1;
      if(event.shiftKey)
        inc = 5;
      if(event.keyCode==65)
      {
        left -= inc;
      }

      if(event.keyCode==87)
      {
        top -= inc;
      }

      if(event.keyCode==68)
      {
        left += inc;
      }

      if(event.keyCode==83)
      {
        top += inc;
      }

      if(event.keyCode==187)
      {
        size++;
      }
      if(event.keyCode==189)
      {
        size--;
      }


      $("img[gridid="+active_grid_id+"]").css("top", top+"%");
      $("img[gridid="+active_grid_id+"]").css("left", left+"%");
      $("img[gridid="+active_grid_id+"]").css("width", size+"%");

      $("img[gridid="+active_grid_id+"]").attr("top", top);
      $("img[gridid="+active_grid_id+"]").attr("left", left);
      $("img[gridid="+active_grid_id+"]").attr("image-resizer", size);
      
      if(event.keyCode==37)
      {
        event.preventDefault();
        return false;
      }
    });


    $(window).keydown(function(event) {

      if(document.activeElement.type=="textarea" || document.activeElement.type=="text")
        return;

      if(active_grid_id=="")
        return;
      
      var rotation = parseInt($("img[gridid="+active_grid_id+"]").attr("image-rotator"));
      if(event.keyCode==69)
      {
        rotation += 1;
      }
      if(event.keyCode==81)
      {
        rotation -= 1;
      }

      rotation_str = "rotate("+rotation+"deg)";

      if(grid_active=="PRIMARY")
      {
        $("img[gridid="+active_grid_id+"]").css("transform", rotation_str);
      }
      else
      {
        $("img[gridid="+active_grid_id+"]").parent().css("transform", rotation_str);
      }
      $("img[gridid="+active_grid_id+"]").attr("image-rotator", rotation);
    });



    $(window).keydown(function(event) {

      if(document.activeElement.type=="textarea" || document.activeElement.type=="text")
        return;

      if(active_grid_id=="")
        return;
      
      if(grid_active=="PRIMARY")
        return;

      var top = parseInt($("div[price-id="+active_grid_id+"]").attr("top"));
      var left = parseInt($("div[price-id="+active_grid_id+"]").attr("left"));

      var inc = 1;
      if(event.shiftKey)
        inc = 5;
      if(event.keyCode==65)
      {
        left -= inc;
      }

      if(event.keyCode==87)
      {
        top -= inc;
      }

      if(event.keyCode==68)
      {
        left += inc;
      }

      if(event.keyCode==83)
      {
        top += inc;
      }

      $("div[price-id="+active_grid_id+"]").css("top", top+"%");
      $("div[price-id="+active_grid_id+"]").css("left", left+"%");

      $("div[price-id="+active_grid_id+"]").attr("top", top);
      $("div[price-id="+active_grid_id+"]").attr("left", left);
    });

    

    function set_background_image()
    {
      if(global_background_image_url=="none")
      {
        $("#flyer-div").css("background-image", "none");
        return;
      }
      $("#flyer-div").css("background-image", "url("+global_background_image_url+")");
      $("#flyer-div").css("background-position", "center");
    }

    function set_border_style()
    {
      $(".secondary-grid-stack-item-content").css("border", "none");
      if(global_border_visible)
      {
        $(".primary-grid-stack-item-content").css("border", "2px solid "+global_border_color);
      }
      else
      {
        $(".primary-grid-stack-item-content").css("border", "none");
      } 
    }


    function HEXtoRGBA(hex, opacity)
    {
      var c;
      if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)){
        c= hex.substring(1).split('');
        if(c.length== 3){
          c= [c[0], c[0], c[1], c[1], c[2], c[2]];
        }
        c= '0x'+c.join('');
        return 'rgba('+[(c>>16)&255, (c>>8)&255, c&255].join(',')+','+opacity+')';
      }
      throw new Error('Bad Hex');
    }


    


    function set_canvas_mode(mode)
    {
      if(mode=="A4 Portrait")
      {
        $("#editor-division-1").attr("class", "scroll-style-1 col m4");
        $("#editor-division-2").attr("class", "col m8 offset-m4");

        $("#download-flyer-btn").css("margin-left", "172mm");
        $("#flyer-div").css("height", "297mm");
        $("#flyer-div").css("width", "210mm");
        $("#header-div").css("width", "210mm");
        $("#flyer-grid").css("width", "210mm");
        $("#grid-stack-div").css("max-height", "260mm");
        $("#footer-div").css("margin-top", "287mm");
        $("#footer-div").css("width", "210mm");
        $("#footer-div").css("height", "10mm");
        $("#mode-label-top").html("A4");
        $("#mode-label-bottom").html("A4");

        $("#flyer-div").css("background-size", "100% 297mm");
      }
      else if(mode=="A4 Landscape")
      {
        $("#editor-division-1").attr("class", "scroll-style-1 col m3");
        $("#editor-division-2").attr("class", "col m9 offset-m3");

        $("#download-flyer-btn").css("margin-left", "258mm");
        $("#flyer-div").css("height", "210mm");
        $("#flyer-div").css("width", "297mm");
        $("#header-div").css("width", "297mm");
        $("#flyer-grid").css("width", "297mm");
        $("#grid-stack-div").css("max-height", "210mm");
        $("#footer-div").css("margin-top", "200mm");
        $("#footer-div").css("width", "297mm");
        $("#footer-div").css("height", "10mm");
        $("#mode-label-top").html("A4");
        $("#mode-label-bottom").html("A4");

        $("#flyer-div").css("background-size", "100% 210mm");
      }
      else if(mode=="A5 Portrait")
      {
        $("#editor-division-1").attr("class", "scroll-style-1 col m4");
        $("#editor-division-2").attr("class", "col m8 offset-m4");

        $("#download-flyer-btn").css("margin-left", "170mm");
        $("#flyer-div").css("height", "210mm");
        $("#flyer-div").css("width", "148mm");
        $("#header-div").css("width", "148mm");
        $("#flyer-grid").css("width", "148mm");
        $("#grid-stack-div").css("max-height", "260mm");
        $("#footer-div").css("margin-top", "200mm");
        $("#footer-div").css("width", "148mm");
        $("#footer-div").css("height", "10mm");
        $("#mode-label-top").html("A5");
        $("#mode-label-bottom").html("A5");

        $("#flyer-div").css("background-size", "100% 210mm");
      }
      else if(mode=="A5 Landscape")
      {
        $("#editor-division-1").attr("class", "scroll-style-1 col m3");
        $("#editor-division-2").attr("class", "col m9 offset-m3");

        $("#download-flyer-btn").css("margin-left", "170mm");
        $("#flyer-div").css("height", "148mm");
        $("#flyer-div").css("width", "210mm");
        $("#header-div").css("width", "210mm");
        $("#flyer-grid").css("width", "210mm");
        $("#grid-stack-div").css("max-height", "148mm");
        $("#footer-div").css("margin-top", "138mm");
        $("#footer-div").css("width", "210mm");
        $("#footer-div").css("height", "10mm");
        $("#mode-label-top").html("A5");
        $("#mode-label-bottom").html("A5");

        $("#flyer-div").css("background-size", "100% 148mm");
      }
    }


  </script>

</body>
</html>
