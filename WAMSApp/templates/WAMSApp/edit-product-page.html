{% extends 'WAMSApp/base.html' %}

{% block content %}

{% load static %}


<link rel = 'stylesheet' type="text/css" href="{% static 'WAMSApp/css/materialize_override.css' %}"/>
<script src="https://cdn.ckeditor.com/ckeditor5/11.0.1/decoupled-document/ckeditor.js"></script>
<link rel="stylesheet" type="text/css" href="{% static 'WAMSApp/css/document_editor.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'WAMSApp/css/main.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'WAMSApp/css/dropdown.css' %}">


<br>
<div>
  <div class="row main-div" style="margin: 0px 70px 0px 0px; padding: 0px 10px !important;" >
    <div class="col s4 image-section" style="padding-right: 0px;">
      <div class="main-image" style="position: relative;">
        <a id="download-image-btn" href="#!" class="right btn-floating btn-small white"
          style="position:absolute;right:0.5em;top:0.5em;z-index: 100;"><i class="material-icons"
            style="color: #521893;">file_download</i></a>
      </div>

      <div class="image-section-dropdown" >
        <div class="input-field image-section-dropdownchild">
          <select id="images-category">
            <option value="All Images" id="all-images-option">All Images</option>
            <option value="Main Images" id="main-images-option">Main Images</option>
            <option value="Sub Images" id="sub-images-option">Sub Images</option>
            <option value="PFL Images" id="pfl-images-option">PFL Images</option>
            <option value="PFL Generated Images" id="pfl-generated-images-option">PFL Generated Images</option>
            <option value="White Background Images" id="white-background-images-option">White Background Images</option>
            <option value="Lifestyle Images" id="lifestyle-images-option">Lifestyle Images</option>
            <option value="Certificate Images" id="certificate-images-option">Certificate Images</option>
            <option value="Giftbox Images" id="giftbox-images-option">Giftbox Images</option>
            <option value="Diecut Images" id="diecut-images-option">Diecut Images</option>
            <option value="A+ Content Images" id="aplus-content-images-option">A+ Content Images</option>
            <option value="Ads Images" id="ads-images-option">Ads Images</option>
            <option value="Unedited Images" id="unedited-images-option">Unedited Images</option>
            <option value="Transparent Images" id="transparent-images-option">Transparent Images</option>
          </select>
        </div>

        <div class="image-section-dropdownchild sidebtn">
          <a href="#upload-image-modal" id="import-btn" class="modal-trigger">
            <i class="material-icons" title="Add Image" style="
              color: gray;
              background-color: white;
              padding: 8px;
             ">
              add_photo_alternate
            </i>
          </a>
        </div>
      </div>

      <div class="row" style="position: relative;bottom: 15px;right: 5px;">
        <div id="graphics-section" class="col s12" style="width: 94%;padding-top: 1.11em;">

        </div>
      </div>
    </div>

    <div class="col s8 center " style="">
      <ul class="scroll-style-2 tabs">
        <li class="active tab"><a href="#vital">VITAL</a></li>
        <li class="tab"><a href="#dimensions">DIMENSIONS</a></li>
        <li class="tab"><a href="#attributes">ATTRIBUTES</a></li>
        <li class="tab"><a href="#pfl">PFL</a></li>

      </ul>

      <div class="scroll-style-1 tab-content ">
        <div class="tab-pane active" id="vital">
          <h4>VITAL</h4>
          <div class="row white" style="margin-bottom: 0em;padding-top: 0em !important;padding-bottom: 0em !important;">
            <div class="input-field col s12" style="margin-top:40px !important;">
              <input placeholder="" id="product-name" type="text">
              <label for="product-name">Product Name</label>
            </div>
          </div>

          <div class="row white" style="margin-bottom: 0em;padding-top: 0em !important;padding-bottom: 0em !important;">
            <div class="input-field col s6">
              <input  placeholder="" id="product-id" type="text">
              <label for="product-id">Product ID</label>
            </div>

            <div class="input-field col s6">
              <select id="product-id-type">
              </select>
              <label for="product-id-type">Product ID Type</label>
            </div>
          </div>

          <div class="row white" style="margin-bottom: 0em;padding-top: 0em !important;padding-bottom: 0em !important;">
            <div class="input-field col s6">
              <input  placeholder="" disabled id="category" type="text">
              <label for="category">Category</label>
            </div>

            <div class="input-field col s6">
              <input  placeholder="" disabled id="subtitle" type="text">
              <label for="subtitle">Subtitle</label>
            </div>
          </div>

          <div class="row white" style="margin-bottom: 0em;padding-top: 0em !important;padding-bottom: 0em !important;">
            <div class="input-field col s6">
              <input  placeholder="" disabled id="brand-name" type="text">
              <label for="brand-name">Brand Name</label>
            </div>

            <div class="input-field col s6">
              <input  placeholder="" disabled id="manufacturer" type="text">
              <label for="manufacturer">Manufacturer</label>
            </div>
          </div>


          <div class="row white" style="margin-bottom: 0em;padding-top: 0em !important;padding-bottom: 0em !important;">
            <div class="input-field col s6">
              <input  placeholder="" disabled id="seller-sku" type="text">
              <label for="seller-sku">Seller SKU</label>
            </div>

            <div class="input-field col s6">
              <input  placeholder="" disabled id="manufacturer-part-number" type="text">
              <label for="manufacturer-part-number">Manufacturer Part Number</label>
            </div>
          </div>

          <div class="row white" style="margin-bottom: 0em;padding-top: 0em !important;padding-bottom: 0em !important;">
            <div class="input-field col s6">
              <input  placeholder="" id="barcode-string" type="text" data-length="20">
              <label for="barcode-string">Barcode</label>
            </div>
          </div>

        </div>

        <div class="tab-pane" id="dimensions">
          <h4>Dimensions</h4>
          <div class="row white" style="padding:20px 40px 20px 40px !important;">
            <div class="row" style="margin-bottom:0px !important;">
                <div class="col s6">
                   <p class="grey-text" style = "margin-bottom: 0px !important;font-size: 10px !important;margin-left: 0px;text-align: left;">EXPORT CARTON QUANTITY ( L | B | H )</p>
                    <div class="row" style="padding-top: 0px !important;padding-left: 0px !important;">
                      <div class="col s3">
                        <div class="input-field" style="font-family: 'AvenirNext';margin-top: 0px !important;">
                          <input placeholder="" id="export-carton-qty-l" type="text" class="validate" style="font-family: 'AvenirNext';">
                        </div>
                      </div>
                      <div class="col s3">
                          <div class="input-field" style="font-family: 'AvenirNext'; margin-top: 0px !important;">
                            <input placeholder="" id="export-carton-qty-b" type="text" class="validate" style="font-family: 'AvenirNext';">
                          </div>
                      </div>
                      <div class="col s3">
                          <div class="input-field" style="font-family: 'AvenirNext'; margin-top: 0px !important;">
                            <input placeholder="" id="export-carton-qty-h" type="text" class="validate" style="font-family: 'AvenirNext';">
                          </div>
                      </div>    
                    </div>
                </div>
                <div class="col s6">
                   <p class="grey-text" style = "margin-bottom: 0px !important;font-size: 10px !important;margin-left: 12px; text-align: left;">EXPORT CARTON CRM ( L | B | H )</p>
                  <div class="row" style="padding-top: 0px !important;padding-left: 0px !important;">
                      <div class="col s3">
                        <div class="input-field" style="font-family: 'AvenirNext';margin-top: 0px !important;">
                          <input placeholder="" id="export-carton-crm-l" type="text" class="validate" style="font-family: 'AvenirNext';">
                        </div>
                      </div>
                      <div class="col s3">
                          <div class="input-field" style="font-family: 'AvenirNext'; margin-top: 0px !important;">
                            <input placeholder="" id="export-carton-crm-b" type="text" class="validate" style="font-family: 'AvenirNext';">
                          </div>
                      </div>
                      <div class="col s3">
                          <div class="input-field" style="font-family: 'AvenirNext'; margin-top: 0px !important;">
                            <input placeholder="" id="export-carton-crm-h" type="text" class="validate" style="font-family: 'AvenirNext';">
                          </div>
                      </div>  
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col s6">
                   <p class="grey-text" style = "margin-bottom: 0px !important;font-size: 10px !important;margin-left: 12px; text-align: left;">PRODUCT DIMENSION ( L | B | H )</p>
                    <div class="row" style="padding-top: 0px !important;padding-left: 0px !important;">
                      <div class="col s3">
                        <div class="input-field" style="font-family: 'AvenirNext';margin-top: 0px !important;">
                          <input placeholder="" id="product-dimension-l" type="text" class="validate" style="font-family: 'AvenirNext';">
                        </div>
                      </div>
                      <div class="col s3">
                          <div class="input-field" style="font-family: 'AvenirNext'; margin-top: 0px !important;">
                            <input placeholder="" id="product-dimension-b" type="text" class="validate" style="font-family: 'AvenirNext';">
                          </div>
                      </div>
                      <div class="col s3">
                          <div class="input-field" style="font-family: 'AvenirNext'; margin-top: 0px !important;">
                            <input placeholder="" id="product-dimension-h" type="text" class="validate" style="font-family: 'AvenirNext';">
                          </div>
                      </div>    
                    </div>
                </div>
                <div class="col s6">
                   <p class="grey-text" style = "margin-bottom: 0px !important;font-size: 10px !important;margin-left: 12px; text-align: left;">GIFT BOX ( L | B | H )</p>
                  <div class="row" style="padding-top: 0px !important;padding-left: 0px !important;">
                      <div class="col s3">
                        <div class="input-field" style="font-family: 'AvenirNext';margin-top: 0px !important;">
                          <input placeholder="" id="gift-box-l" type="text" class="validate" style="font-family: 'AvenirNext';">
                        </div>
                      </div>
                      <div class="col s3">
                          <div class="input-field" style="font-family: 'AvenirNext'; margin-top: 0px !important;">
                            <input placeholder="" id="gift-box-b" type="text" class="validate" style="font-family: 'AvenirNext';">
                          </div>
                      </div>
                      <div class="col s3">
                          <div class="input-field" style="font-family: 'AvenirNext'; margin-top: 0px !important;">
                            <input placeholder="" id="gift-box-h" type="text" class="validate" style="font-family: 'AvenirNext';">
                          </div>
                      </div>  
                    </div>
                </div>
            </div>
      </div>
        </div>

        <div class="tab-pane" id="attributes">
          <h4>Attributes</h4>
          <div class="row white" style="margin-bottom:0px !important;">
            <div class="col s12">
              <div class="row" style="margin-bottom: 0em;padding-top:0em !important;padding-bottom:0em !important;">
                <div class="input-field col s6">
                  <input  placeholder="" id="color" type="text">
                  <label for="color">Color</label>
                </div>
                <div class="input-field col s6">
                  <input  placeholder="" id="color-map" type="text">
                  <label for="color-map">Color Map</label>
                </div>
              </div>


              <div class="row" style="margin-bottom: 0em;padding-top:0em !important;padding-bottom:0em !important;">
                <div class="input-field col s6">
                  <input  placeholder="" id="material-type" type="text">
                  <label for="material-type">Material Type</label>
                </div>
                <div class="input-field col s6">
                  <input  placeholder="" id="standard-price" type="number">
                  <label for="standard-price">Standard Price</label>
                </div>
              </div>

              <div class="row" style="margin-bottom: 0em;padding-top:0em !important;padding-bottom:0em !important;">
                <div class="input-field col s6">
                  <input  placeholder="" id="quantity" type="number">
                  <label for="quantity">Quantity</label>
                </div>
              </div>              

              <div class="row" style="margin-bottom: 0em;padding-top: 0em !important;padding-bottom: 0em !important;">
                <div class="input-field col s12">
                  <input  placeholder="" id="factory-notes" type="text">
                  <label for="">Factory Notes</label>
                </div>
              </div>

            </div>
          </div>
        </div>

        <div class="tab-pane" id="pfl">
          <h4>PFL</h4>
          <div class="row white" style="margin-bottom:0px !important;">
            <div class="input-field col s12">
              <input  placeholder="" id="pfl-product-name" type="text">
              <label for="pfl-product-name">PFL Product Name</label>
            </div>

            <div id="feature-summary-editor-div" class="row">
              <div class="input-field col s9">
                <input  placeholder="" class="feature-text" id="pfl-feature-1" type="text">
                <label for="pfl-feature-1">Feature</label>
              </div>

              <div class="input-field col s1">
                <a id="add-feature-btn" href="#!" class="btn-floating blue"
                  style="background-color: #512ea8 !important; transform: scale(0.7);box-shadow: none;"><i
                    class="material-icons">add</i></a>
              </div>
            </div>
          </div>
        </div>



      </div>
    </div>
  </div>
</div>


<div id="upload-image-modal" class="modal">
  <div class="modal-content">
    <h4 style="font-family:'AvenirNext';font-size:18px;">Upload Image</h4>
    <div class="file-field input-field">
      <div class="btn" style="background-color: #512da8">
        <span style="font-size:14px;">File</span>
        <input id="product-image-input" type="file" multiple>
      </div>
      <div class="file-path-wrapper">
        <input class="file-path validate" type="text">
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <a href="#!" class="modal-close waves-effect waves-green btn-flat">Cancel</a>
    <a id="upload-image-btn" href="#!" class="waves-effect waves-green btn-flat blue white-text"
      style="background-color:#009051 !important ;">Upload</a>
    <div class="progress" id="upload-preloader"
      style="display:none;margin: 0px !important;background-color: white !important;">
      <div class="indeterminate" style="background-color: #512de8;"></div>
    </div>
  </div>
</div>


<div id="delete-image-modal" class="modal">
  <div class="modal-content">
    <h4 style="font-family:'AvenirNext';font-size:18px;">Are you sure you want to delete the image?</h4>
  </div>
  <div class="modal-footer">
    <a href="#!" class="modal-close waves-effect waves-green btn-flat">Cancel</a>
    <a id="delete-image-btn" href="#!" class="red waves-effect waves-red btn-flat white-text">Delete</a>
  </div>
</div>



<div class="toolbar"
  style="position: fixed; top: 0px; right: 0px;padding:20px 5px 20px 5px; height: 100vh; background-color: white;">
  <a class="right" href="#!" onclick="window.close()"
    style="background-color: transparent;display: block;cursor: pointer;">
    <i class="material-icons redd" title="Close" style="
      background-color: #f7f7f7;
      padding: 8px;
      color: gray;
      border-radius: 5px;
      margin-left: 8px;
      font-size: 20px;
      margin-right: 9px;
      display: block;
      margin-bottom: 10px;">
      close
    </i>
  </a>
  </br>

  <a class="right" href="/products" style="background-color: transparent;display: block;cursor: pointer;">
    <i class="material-icons homee" title="Products" style="
      background-color: #f7f7f7;
      padding: 8px;
      color: gray;
      border-radius: 5px;
      margin-left: 8px;
      font-size: 20px;
      margin-right: 9px;
      display: block;
      margin-bottom: 10px;">
      select_all
    </i>
  </a>

  <div style="background-color: transparent; position: absolute;bottom: 15px;right: 4px;">
    <a id="pfl-editor-link" href="#!" class=" right" style="background-color: transparent;display: block;">
      <i class="material-icons maroonn" title="PFL Editor" style="
        color: gray;
        background-color: #f7f7f7;
        padding: 8px;
        border-radius: 5px;
        margin-left: 8px;
        font-size: 20px;
        margin-right: 9px;
        display: block;margin-bottom: 10px;">
        vertical_split
      </i>
    </a>

    <a href="#!" class=" right" style="background-color: transparent;display: block;">
      <i id="pending-icon" class="material-icons yelloww" title="Pending" style="
        background-color: #f7f7f7;
        padding: 8px;
        color: gray;
        border-radius: 5px;
        margin-left: 8px;
        font-size: 20px;
        margin-right: 9px;
        display: block;
        margin-bottom: 10px;">
        timer
      </i>
    </a>

    <a href="#!" class=" right" style="background-color: transparent;display: block;">
      <i id="verified-icon" class="material-icons greenn" title="Verified" style="
        background-color: #f7f7f7;
        padding: 8px;
        color: gray;
        border-radius: 5px;
        margin-left: 8px;
        font-size: 20px;
        margin-right: 9px;
        display: block;
        margin-bottom: 10px;">
        verified_user
      </i>
    </a>

    <a href="#!" id="main-image-select-save-btn" class="right" style="background-color: transparent;display: block;">
      <i class="material-icons bluee" title="Set Cover Image" style="
        background-color: #f7f7f7;
        padding: 8px;
        color: gray;
        border-radius: 5px;
        margin-left: 8px;
        font-size: 20px;
        margin-right: 9px;
        display: block;
        margin-bottom: 10px;">
        burst_mode
      </i>
    </a>

    <a href="#download-export-list-modal" class="modal-trigger right" style="background-color: transparent;">
      <i class="material-icons greenn" title="Export Product Details" style="
        background-color: #f7f7f7;
        padding: 8px;
        color: gray;
        border-radius: 5px;
        margin-left: 8px;
        font-size: 20px;
        margin-right: 9px;
        display: block;
        margin-bottom: 10px;">
        file_download
      </i>
    </a>

    {% if perms.WAMSApp.change_product %}
    <a href="#!" id="save-btn" class="right" style="background-color: transparent;">
      <i class="material-icons purplee" title="Save" style="
          background-color: #f7f7f7;
          padding: 8px;
          color: gray;
          border-radius: 5px;
          margin-left: 8px;
          font-size: 20px;
          margin-right: 9px;
          display: block;
          margin-bottom: 10px;">
        save
      </i>
    </a>
    {% endif %}
  </div>
</div>


<div id="download-export-list-modal" class="modal" style="border-radius: 5px;">
  <div class="modal-content">
    <h5 style="font-family: 'AvenirNext';font-size: 18px;">EXPORT PRODUCT</h5>
    <br>
    <div class="row">
      <div class="input-field col s6" style="padding-left: 0em !important;">
        <select id="export-format">
          <option value="Amazon UK" selected>Amazon UK</option>
          <option value="Amazon UAE">Amazon UAE</option>
          <option value="Ebay">Ebay</option>
          <option value="Noon">Noon</option>
          <!-- <option value="Ebay" style="font-family: 'AvenirNextRegular';">Ebay</option>   -->
        </select>
        <label style="margin-left: 0em !important;">Export Format</label>
      </div>

      <div class="input-field col s6">
      </div>
    </div>
  </div>
  <div class="modal-footer" style="margin-bottom: 15px">
    <a href="#!" class="modal-close waves-effect btn-flat" style="margin-right: 20px;">Close</a>
    <a id="download-product-btn" href="#!" class="waves-effect btn-flat white-text"
      style="margin-right: 20px;background-color: #521893 !important;">Download</a>
  </div>
</div>


<div id="pfl-div" class="row white"
  style="text-align: center;margin-left: auto;display:none;height: 297mm;width: 210mm;">
  <!-- Brand Image Preview -->
  <div id="brand-image" class="col s6 right">
    <br>
    <img id="brand-image-img" src="" style="width: 73.5mm;margin-left:-27mm;display: none;position: absolute;">
  </div>

  <!-- Product Image Preview -->
  <div class="col s12" style="text-align: center; position: absolute;width: 210mm;margin-top: 40mm;">
    <img id="pfl-product-image-preview-img"
      style="max-width: 90%;max-height: 130mm;object-fit: scale-down;display: none;background-size: 100% 100%;">
    <br>
  </div>

  <!-- Product Name Preview -->
  <div class="col s12"
    style="background-color:#521893;text-align: center;width: 210mm;padding-bottom: 1em;position: absolute;margin-top: 190mm;width:210mm;height: 20mm;">
    <div id="product-name-preview" class="white-text left"
      style="padding-left: 1em;text-transform: uppercase;margin-top: 6.4mm;font-size: 1.7em;font-family:'AvenirNextRegular';">
    </div>
  </div>

  <!-- Seller SKU Preview -->
  <div class="col s12"
    style="background-color:white;position: absolute;margin-top: 192.5mm;width:45mm;height: 15mm;margin-left: 156mm;text-align: center;">
    <span id="seller-sku-preview"
      style="font-size: 1.4em;font-family:'AvenirNextRegular'; line-height: 16mm;color:#521893;"></span>
  </div>

  <!-- Features Preview -->
  <div class="col s12" style="position: absolute;margin-top: 218mm;width: 10mm;">
    <span style="color:#521893;font-size: 1.4em;font-family: 'AvenirNext';padding-left: 1em;">Features</span>
  </div>
  <div class="col s12" style="margin-top: 215mm;">
    <div id="features-preview-div" style="text-align: left; padding-left: 1.3em;">
    </div>
  </div>


  <!-- Barcode Preview -->
  <div class="col s3" style="position: absolute;margin-top: 240mm;width:45mm;margin-left:152mm;">
    <br><br>
    <img id="barcode-image-preview-img" src="" style="display:none;width: 100%;">
  </div>

  <!-- Footer -->
  <div class="col s12" style="background-color:#521893;position: absolute;margin-top: 287mm;width:210mm;height: 10mm;">
    <div class="white-text" style="font-size: 1.1em;margin-top:-1mm;">
      <p class="right" style="color:#009051;font-size: 0.8em;color:white;font-family:'AvenirNextRegular';">For more
        information, please visit www.royalford.com</p>
    </div>
  </div>

</div>


<script type="text/javascript" src="{% static 'WAMSApp/js/html2canvas.js' %}"></script>
<script type="text/javascript" src="{% static 'WAMSApp/js/canvas2image.js' %}"></script>
<script type="text/javascript">

  $('.tabs').tabs();
  $('.chips').chips();
  $('select').formSelect();
  $('.modal').modal();
  $('body').css('background-color', '#ebebeb');
  $('#barcode-string').characterCounter();

  var global_verification_status = false;
  var global_delete_image_pk = null;

  //Page reload prevent logic
  // let savecounter = false;
  // $('#save-btn').click(() => {
  //   savecounter = false;
  // })

  // $('input').click(function () {
  //   savecounter = true;
  // })

  // function preventDefault() {
  //   if (savecounter) {
  //     alert('Please save the details before refreshing!');
  //   }
  //   else {
  //     window.close();
  //   }
  // }

  // window.addEventListener('beforeunload', function (e) {
  //   if (savecounter) {
  //     e.preventDefault();
  //     e.returnValue = '';
  //   }
  //   else
  //     window.close();
  // });

  $('#close-btn').click(function () {
    preventDefault();
  })


  $("#download-product-btn").click(function () {

    var export_format = $("#export-format").val();

    $.ajax({
      url: "/download-product/",
      type: "POST",
      headers: {
        'X-CSRFToken': getCsrfToken()
      },
      data: {
        product_pk: window.location.pathname.split("/")[2],
        export_format: export_format
      },
      success: function (response) {
        console.log("Success!", response);
        $("#download-export-list-modal").modal("close");
        var file_path = response["file_path"]
        window.open(file_path);
      },
      error: function (xhr, textstatus, errorthrown) {
        console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
      }
    });

  });

 

  $("#pending-icon").click(function () {
    if (global_verification_status) {
      call_verify_api(0);
    }
  });

  $("#verified-icon").click(function () {
    if (!global_verification_status) {
      call_verify_api(1);
    }
  });

  function call_verify_api(verify) {
    var fd = new FormData()
    fd.append("product_pk", window.location.pathname.split("/")[2]);
    fd.append("verify", verify);

    $.ajax({
      url: "/verify-product/",
      type: "POST",
      headers: {
        'X-CSRFToken': getCsrfToken()
      },
      processData: false,
      contentType: false,
      data: fd,
      success: function (response) {
        console.log("Success!", response);
        if (response["status"] == 200) {
          if (verify == 1) {
            set_verify(true);
            global_verification_status = true;
            M.toast({ html: "Product status changed to verified" });
          }
          else {
            set_verify(false);
            global_verification_status = false;
            M.toast({ html: "Product status changed to pending" });
          }
        }
        else if (response["status"] == 403) {
          M.toast({ html: "You do not have access to update the status!" });
        }
        else {
          M.toast({ html: "Error updating the status!" });
        }
      },
      error: function (xhr, textstatus, errorthrown) {
        console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
      }
    });
  }

  $(document).ready(function () {
    $('.tabs').tabs();
  });


  $("#download-image-btn").click(function () {

    $("#download-image-btn").attr("disabled", "disabled");
    var high_def_url = $($(".preview-img")[0]).attr("high_def_url");
    var image_links = [];
    image_links.push({
      "key": "high_def_url",
      "url": high_def_url
    })

    $.ajax({
      url: "/download-images-s3/",
      type: "POST",
      headers: {
        'X-CSRFToken': getCsrfToken()
      },
      data: {
        links: JSON.stringify(image_links)
      },
      success: function (response) {
        console.log("Success! ", response);
        $("#download-image-btn").removeAttr("disabled");
        if (response["status"] == 200) {
          var local_link = response["local_links"][0]["url"];

          var a = document.createElement('a');
          a.href = local_link;
          var filename = high_def_url.split("/")[high_def_url.split("/").length - 1];
          a.download = filename;
          a.click();
        }
      },
      error: function (xhr, textstatus, errorthrown) {
        console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
        $("#download-image-btn").removeAttr("disabled");
      }
    });
  });

  var pfl_feature_cnt = 2;

  $("#add-feature-btn").click(function () {
    var html_string = `<div class="feature-div">
                         <div class="input-field col s9">
                           <input class="feature-text" id="pfl-feature-`+ pfl_feature_cnt + `" type="text" >
                           <label for="pfl-feature-`+ pfl_feature_cnt + `">Feature</label>
                         </div>

                        <div class="input-field col s1">
                          <a href="#!" class="delete-feature-btn btn-floating red" style="transform: scale(0.7);box-shadow: none;"><i class="material-icons">remove</i></a>
                        </div>
                      </div>`;
    $("#feature-summary-editor-div").append(html_string);
    pfl_feature_cnt++;
  });

  $(document).on("click", ".delete-feature-btn", function(){
    $(this).parent().parent().remove();
  })
  

  function getCsrfToken() {
    var CSRF_TOKEN = $('input[name="csrfmiddlewaretoken"]').val();
    return CSRF_TOKEN;
  }

  var global_images = {};
  var global_image_key = "all_images";

  function fetch_constant_values() {
    $.ajax({
      url: "/fetch-constant-values/",
      type: "POST",
      headers: {
        'X-CSRFToken': getCsrfToken()
      },
      data: {},
      success: function (response) {
        console.log("Success!", response);
        if (response["status"] == 200) {
          var autocomplete_data = {}
          var material_list = response["material_list"];
          for (var i = 0; i < material_list.length; i++) {
            autocomplete_data[material_list[i]["name"]] = null;
          }
          $('#material-type').autocomplete({
            data: autocomplete_data
          });

          autocomplete_data = {};
          var ebay_category_list = response["ebay_category_list"];
          for (var i = 0; i < ebay_category_list.length; i++) {
            autocomplete_data[ebay_category_list[i]["name"] + "|" + ebay_category_list[i]["category_id"]] = null;
          }
          $('#category').autocomplete({
            data: autocomplete_data,
            onAutocomplete: function (val) {
              var category_id = val.split("|")
              category_id = category_id[category_id.length - 1];
              $("#category").val(category_id);
            }
          });


          autocomplete_data = {};
          var brand_list = response["brand_list"];
          for (var i = 0; i < brand_list.length; i++) {
            autocomplete_data[brand_list[i]["name"]] = null;
          }
          $('#brand-name').autocomplete({
            data: autocomplete_data
          });


          var product_id_type_list = response["product_id_type_list"];
          var html_string = `<option value="" selected>Choose Product ID Type</option>`;
          for (var i = 0; i < product_id_type_list.length; i++) {
            html_string += `<option value="` + product_id_type_list[i]["name"] + `">` + product_id_type_list[i]["name"] + `</option>`
          }




          $("#product-id-type").html(html_string);
          $('select').formSelect();
        }
        else {
          //M.toast({html:"Duplicate product detected!"});
        }
        //$("#save-btn").removeAttr("disabled");
      },
      error: function (xhr, textstatus, errorthrown) {
        console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
      }
    });
  }

  fetch_constant_values();
  fetch_product_images_details();


  function fetch_product_images_details() {
    $.ajax({
      url: "/fetch-product-details/",
      type: "POST",
      headers: {
        'X-CSRFToken': getCsrfToken()
      },
      data: {
        product_pk: window.location.pathname.split("/")[2]
      },
      success: function (response) {
        console.log("Success!", response);

        if (response["status"] == 200) {
          $('.material-placeholder').remove();
          $('.main-image').append(`<img class = "preview-img materialboxed" src='` + response["repr_image_url"] + `' high_def_url="` + response["repr_high_def_url"] + `">`)
          $('.materialboxed').materialbox();

          global_images = response["images"];

          $("#all-images-option").html("All Images ("+global_images["all_images"].length+")");
          $("#main-images-option").html("Main Images ("+global_images["main_images"].length+")");
          $("#sub-images-option").html("Sub Images ("+global_images["sub_images"].length+")");
          $("#pfl-images-option").html("PFL Images ("+global_images["pfl_images"].length+")");
          $("#pfl-generated-images-option").html("PFL Generated Images ("+global_images["pfl_generated_images"].length+")");
          $("#white-background-images-option").html("White Background Images ("+global_images["white_background_images"].length+")");
          $("#lifestyle-images-option").html("Lifestyle Images ("+global_images["lifestyle_images"].length+")");
          $("#certificate-images-option").html("Certificate Images ("+global_images["certificate_images"].length+")");
          $("#giftbox-images-option").html("Giftbox Images ("+global_images["giftbox_images"].length+")");
          $("#diecut-images-option").html("Diecut Images ("+global_images["diecut_images"].length+")");
          $("#aplus-content-images-option").html("A+ Content Images ("+global_images["aplus_content_images"].length+")");
          $("#ads-images-option").html("Ads Images ("+global_images["ads_images"].length+")");
          $("#unedited-images-option").html("Unedited Images ("+global_images["unedited_images"].length+")");
          $("#transparent-images-option").html("Transparent Images ("+global_images["transparent_images"].length+")");
          
          update_grid_images(global_image_key);

          $('#brand-image-img').attr("src", response["brand_logo"]);
          if (global_images["main_images"].length > 0) {
            $('#pfl-product-image-preview-img').attr("src", global_images["main_images"][0]["main-url"]);
          }
          $('#barcode-image-preview-img').attr("src", response["barcode_image_url"]);

          M.updateTextFields();
          $('select').formSelect();
        }
        else {
          M.toast({ html: "Error fetching images information" });
        }
      },
      error: function (xhr, textstatus, errorthrown) {
        console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
      }
    });
  }


  $("#upload-image-btn").click(function () {

    $("#upload-image-btn").attr("disabled", "disabled");
    $("#upload-preloader").show();

    product_pk = window.location.pathname.split("/")[2];

    var fd = new FormData();

    fd.append("product_pk", product_pk);
    var product_image_input = document.getElementById("product-image-input");

    fd.append('image_count', product_image_input.files.length);
    for (var i = 0; i < product_image_input.files.length; i++) {
      fd.append('image_' + i, product_image_input.files[i]);
    }


    fd.append('image_category', global_image_key);
    fd.append('channel_name',"");

    $.ajax({
      url: "/upload-product-image/",
      type: "POST",
      headers: {
        'X-CSRFToken': getCsrfToken()
      },
      processData: false,
      contentType: false,
      data: fd,
      success: function (response) {
        console.log("Success!", response);
        $("#upload-preloader").hide();
        $("#upload-image-btn").removeAttr("disabled");

        if (response["status"] == 200) {
          $("#upload-image-modal").modal("close");
          M.toast({ html: "Successfully uploaded images!" });
          fetch_product_images_details();
        }
        else if (response["status"] == 403) {
          M.toast({ html: "You do not have permission to upload images!" });
        }
        else {
          M.toast({ html: "Error uploading images!" });
        }
      },
      error: function (xhr, textstatus, errorthrown) {
        console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
        $("#upload-preloader").hide();
      }
    });
  })

  function set_verify(verified) {
    if (verified == true) {
      $("#pending-icon").css("background-color", "#f7f7f7");
      $("#pending-icon").css("color", "gray");
      $("#verified-icon").css("background-color", "#009051");
      $("#verified-icon").css("color", "white");
    }
    else {
      $("#verified-icon").css("background-color", "#f7f7f7");
      $("#verified-icon").css("color", "gray");
      $("#pending-icon").css("background-color", "orange");
      $("#pending-icon").css("color", "white");
    }
  }

  function fetch_product_details() {
    $.ajax({
      url: "/fetch-product-details/",
      type: "POST",
      headers: {
        'X-CSRFToken': getCsrfToken()
      },
      data: {
        product_pk: window.location.pathname.split("/")[2]
      },
      success: function (response) {
        console.log("Success!", response);

        if(response["status"]==200)
        {
          $("#product-name").val(response["product_name"]);
          $("#category").val(response["category"]);
          $("#subtitle").val(response["subtitle"]);
          $("#brand-name").val(response["brand_name"]);
          $("#manufacturer").val(response["manufacturer"]);
          $("#product-id").val(response["product_id"]);
          $("#product-id-type").val(response["product_id_type"]);
          $("#seller-sku").val(response["seller_sku"]);
          $("#manufacturer-part-number").val(response["manufacturer_part_number"]);
          $("#barcode-string").val(response["barcode_string"]);


          console.log("dimension" , response);
          
          $("#color").val(response["color"]);
          $("#color-map").val(response["color_map"]);
          $("#material-type").val(response["material_type"]);
          $("#standard-price").val(response["standard_price"]);
          $("#quantity").val(response["quantity"]);
          $("#factory-notes").val(response["factory_notes"]);

          $("#pfl-product-name").val(response["pfl_product_name"]);
          

          var pfl_features = response["pfl_product_features"];
          if(pfl_features.length>0)
          {
            $("#pfl-feature-1").val(pfl_features[0]);
          }
          for(var i=1;i<pfl_features.length;i++)
          {
            $("#add-feature-btn").click();
            $("#pfl-feature-"+(i+1)).val(pfl_features[i]);
          }

          global_verification_status = response["verified"];
          if (response["verified"] == true) {
            set_verify(true);
          }
          else {
            set_verify(false);
          }

          M.updateTextFields();
          $('select').formSelect();
        }












        // $("#pfl-product-name").val(response["pfl_product_name"])
        // var pfl_product_features = response["pfl_product_features"]
        // $('.material-placeholder').remove();
        // $('.main-image').append(`<img class = "preview-img materialboxed" src='` + response["repr_image_url"] + `' high_def_url="` + response["repr_high_def_url"] + `">`)
        // $('.materialboxed').materialbox();

        // for (var i = 0; i < pfl_product_features.length; i++) {
        //   $("#pfl-feature-" + (i + 1)).val(pfl_product_features[i]);
        //   if ((i + 1) != pfl_product_features.length) {
        //     $("#add-feature-btn").click();
        //   }
        // }


        // global_images = response["images"];

        // $("#all-images-option").html("All Images ("+global_images["all_images"].length+")");
        // $("#main-images-option").html("Main Images ("+global_images["main_images"].length+")");
        // $("#sub-images-option").html("Sub Images ("+global_images["sub_images"].length+")");
        // $("#pfl-images-option").html("PFL Images ("+global_images["pfl_images"].length+")");
        // $("#pfl-generated-images-option").html("PFL Generated Images ("+global_images["pfl_generated_images"].length+")");
        // $("#white-background-images-option").html("White Background Images ("+global_images["white_background_images"].length+")");
        // $("#lifestyle-images-option").html("Lifestyle Images ("+global_images["lifestyle_images"].length+")");
        // $("#certificate-images-option").html("Certificate Images ("+global_images["certificate_images"].length+")");
        // $("#giftbox-images-option").html("Giftbox Images ("+global_images["giftbox_images"].length+")");
        // $("#diecut-images-option").html("Diecut Images ("+global_images["diecut_images"].length+")");
        // $("#aplus-content-images-option").html("A+ Content Images ("+global_images["aplus_content_images"].length+")");
        // $("#ads-images-option").html("Ads Images ("+global_images["ads_images"].length+")");
        // $("#unedited-images-option").html("Unedited Images ("+global_images["unedited_images"].length+")");
        // $("#transparent-images-option").html("Transparent Images ("+global_images["transparent_images"].length+")");
        

        // update_grid_images(global_image_key);

        // $('#brand-image-img').attr("src", response["brand_logo"]);
        // if (global_images["main_images"].length > 0) {
        //   $('#pfl-product-image-preview-img').attr("src", global_images["main_images"][0]["main-url"]);
        // }
        // $('#barcode-image-preview-img').attr("src", response["barcode_image_url"]);

        // $("#pfl-editor-link").attr("href", "/pfl/" + response["pfl_pk"]);

        // M.updateTextFields();
        // $('select').formSelect();
      },
      error: function (xhr, textstatus, errorthrown) {
        console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
      }
    });
  }

  fetch_product_details();


  function update_grid_images_main_images(key) {
    var html_string = "";
    for (var i = 0; i < global_images[key].length; i++) {
      var checked = "";
      if (global_images[key][i]["is_main_image"] == true) {
        checked = "checked";
      }

      if (i % 3 == 0) {
        html_string += "<div class='flex-container-space-btw' style='margin-top:0em;margin-bottom:0em;padding-top:0em !important;padding-bottom:0em !important;width:25.5vw !important;'>";
      }

      html_string += `<div style=";position:relative;">
                        <a href="#delete-image-modal" id="delimg-`+ global_images[key][i]["pk"] + `" class="delete-image-modal-btn modal-trigger right" style="position:absolute;top:4px;right:2px;z-index:100;background-color: transparent;display: block;cursor: pointer;" title="Delete Image">
                          <i class="material-icons redd" title="Delete Image" style="
                            background-color: transparent;
                            padding: 4px;
                            color: gray;
                            border-radius: 2px;
                            margin-left: 4px;
                            font-size: 10px;
                            margin-right: 4px;
                            display: block;
                            margin-bottom: 5px;">
                            close
                          </i>
                        </a>
                        <img class="miniimage" src="`+ global_images[key][i]["thumbnail-url"] + `" midimage_url="` + global_images[key][i]["midimage-url"] + `" high_def_url="` + global_images[key][i]["main-url"] + `"  style="width: 100%;object-fit:contain;">
                        <label style="margin-left:0px !important;">
                          <input value="`+ global_images[key][i]["pk"] + `" name="group1" type="radio" ` + checked + ` />
                          <span class = "checkbox"></span>
                        </label>
                      </div>`;

      if (i % 3 == 2 || i == global_images[key].length - 1) {
        html_string += "</div>";
      }
    }

    $("#graphics-section").html(html_string);
  }


  $(document).on('click', '.miniimage', function () {
    let url = $(this).attr('midimage_url');
    let high_def_url = $(this).attr('high_def_url');
    $('.material-placeholder').remove();
    $('.main-image').append(`<img class = "preview-img materialboxed" src = '` + url + `' high_def_url="` + high_def_url + `">`)
    $('.materialboxed').materialbox();
  });

  $(document).on("click", ".delete-image-modal-btn", function () {
    global_delete_image_pk = this.id.split("-")[1];
  })

  $("#delete-image-btn").click(function () {
    delete_image();
  })

  function delete_image() {
    var image_type = "";
    if (global_image_key == "sub_images" || global_image_key == "main_images") {
      image_type = "main_sub";
    }
    else {
      image_type = "other";
    }

    var fd = new FormData();
    fd.append("image_pk", global_delete_image_pk);
    fd.append("image_type", image_type);

    $.ajax({
      url: "/delete-image/",
      type: "POST",
      headers: {
        'X-CSRFToken': getCsrfToken()
      },
      processData: false,
      contentType: false,
      data: fd,
      success: function (response) {
        console.log("Success!", response);
        if (response["status"] == 200) {
          M.toast({ html: "Image successfully deleted!" });
          $("#delete-image-modal").modal("close");
          fetch_product_images_details();
        }
        else if (response["status"] == 403) {
          M.toast({ html: "You do not have permission to delete images!" });
        }
        else {
          M.toast({ html: "Error deleting image!" });
        }
      },
      error: function (xhr, textstatus, errorthrown) {
        console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
      }
    });
  }

  $("#main-image-select-save-btn").click(function () {

    if (global_image_key != "main_images") {
      return;
    }

    var fd = new FormData();

    var checked_pk = $("input[name=group1]:checked").val();
    fd.append("checked_pk", checked_pk);
    fd.append("product_pk", window.location.pathname.split("/")[2]);

    $.ajax({
      url: "/update-main-image/",
      type: "POST",
      headers: {
        'X-CSRFToken': getCsrfToken()
      },
      processData: false,
      contentType: false,
      data: fd,
      success: function (response) {
        console.log("Success!", response);
        if (response["status"] == 200) {
          M.toast({ html: "Main image updated successfully!" });
        }
        else if (response["status"] == 403) {
          M.toast({ html: "You do not have permission to update main image!" });
        }
        else {
          M.toast({ html: "Error updating main image!" });
        }
      },
      error: function (xhr, textstatus, errorthrown) {
        console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
      }
    });
  });


  function update_grid_images_sub_images(key) {
    var html_string = "";
    for (var i = 0; i < global_images[key].length; i++) {
      var checked = "";
      if (global_images[key][i]["is_sub_image"] == true) {
        checked = "checked";
      }

      if (i % 3 == 0) {
        html_string += "<div class='flex-container-space-btw' style='margin-top:0em;margin-bottom:0em;padding-top:0em !important;padding-bottom:0em !important;width:25.5vw !important;'>";
      }

      var sub_image_index = global_images[key][i]["sub_image_index"];
      if (sub_image_index == 0)
        sub_image_index = "-"

      html_string += `<div class="" style="position:relative;">
                        <a href="#delete-image-modal" id="delimg-`+ global_images[key][i]["pk"] + `" class="delete-image-modal-btn modal-trigger right" style="position:absolute;top:4px;right:4px;z-index:100;background-color: transparent;display: block;cursor: pointer;" title="Delete Image">
                          <i class="material-icons redd" title="Delete Image" style="
                            background-color: transparent;
                            padding: 4px;
                            color: gray;
                            border-radius: 2px;
                            margin-left: 4px;
                            font-size: 10px;
                            margin-right: 4px;
                            display: block;
                            margin-bottom: 5px;">
                            close
                          </i>
                        </a>
                        <img class="miniimage" src="`+ global_images[key][i]["thumbnail-url"] + `" midimage_url="` + global_images[key][i]["midimage-url"] + `" high_def_url="` + global_images[key][i]["main-url"] + `" style="width: 100%;object-fit:contain;">
                        <input value="`+ sub_image_index + `" id="subcheck_` + global_images[key][i]["pk"] + `" type="text">
                      </div>`;

      if (i % 3 == 2 || i == global_images[key].length - 1) {
        html_string += "</div>";
      }
    }
    $("#graphics-section").html(html_string);
  }

  function save_subimages_index() {
    if (global_image_key != "sub_images") {
      return;
    }
    var fd = new FormData();

    var sub_image = [];
    var key = "sub_images";

    // Check for condition
    var unique_sub_index = [];
    for (var i = 0; i < global_images[key].length; i++) {
      var sub_image_index = $("#subcheck_" + global_images[key][i]["pk"]).val().trim();
      if (sub_image_index != "-" && sub_image_index != "") {
        sub_image_index = parseInt(sub_image_index);
        if (sub_image_index >= 1 && sub_image_index <= 8) {
          console.log("Key: ", sub_image_index);
          if (unique_sub_index.includes(sub_image_index)) {
            M.toast({ html: "Sub Image indices must be unique" })
            return;
          }

          unique_sub_index.push(sub_image_index);
        }
        else {
          M.toast({ html: "Sub Image indices must be between 1 to 8" })
          return;
        }
      }
    }


    for (var i = 0; i < global_images[key].length; i++) {
      var temp_dict = {};
      temp_dict["pk"] = global_images[key][i]["pk"];
      var sub_image_index = $("#subcheck_" + global_images[key][i]["pk"]).val();
      if (sub_image_index == "" || sub_image_index == "-")
        sub_image_index = "0"
      temp_dict["sub_image_index"] = sub_image_index;
      sub_image.push(temp_dict);
    }

    fd.append("sub_images", JSON.stringify(sub_image));
    fd.append("product_pk", window.location.pathname.split("/")[2]);

    $.ajax({
      url: "/update-sub-images/",
      type: "POST",
      headers: {
        'X-CSRFToken': getCsrfToken()
      },
      processData: false,
      contentType: false,
      data: fd,
      success: function (response) {
        console.log("Success!", response);
        if (response["status"] == 200) {
          M.toast({ html: "Sub images updated successfully!" });
        }
        else if (response["status"] == 403) {
          M.toast({ html: "You do not have permission to update sub images!" });
        }
        else {
          M.toast({ html: "Error updating sub images!" });
        }
      },
      error: function (xhr, textstatus, errorthrown) {
        console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
      }
    });
  }


  function update_grid_images(key) {
    if (key == "all_images") {
      $("#import-btn").attr("class", "disabled");
    }
    else {
      $("#import-btn").attr("class", "modal-trigger");
    }

    if (key == "main_images") {
      update_grid_images_main_images(key);
      return;
    }


    if (key == "sub_images") {
      update_grid_images_sub_images(key);
      return;
    }


    var html_string = "";
    for (var i = 0; i < global_images[key].length; i++) {
      html_string += `<div class="col s4" style="padding:1em;">
                        <div style="position:relative;">
                          <a href="#delete-image-modal" id="delimg-`+ global_images[key][i]["pk"] + `" class="delete-image-modal-btn modal-trigger right" style="position:absolute;top:4px;right:2px;z-index:100;background-color: transparent;display: block;cursor: pointer;" title="Delete Image">
                            <i class="material-icons redd" title="Delete Image" style="
                              background-color: transparent;
                              padding: 4px;
                              color: gray;
                              border-radius: 2px;
                              margin-left: 4px;
                              font-size: 10px;
                              margin-right: 4px;
                              display: block;
                              margin-bottom: 5px;">
                              close
                            </i> 
                          </a> 
                          <img class="miniimage" src="`+ global_images[key][i]["thumbnail-url"] + `" midimage_url="` + global_images[key][i]["midimage-url"] + `" high_def_url="` + global_images[key][i]["main-url"] + `" style="width: 100%;object-fit:contain;">
                        </div>
                      </div>`;
    }

    $("#graphics-section").html(html_string);
  }



  $("#images-category").change(function () {
    if ($("#images-category").val() == "All Images") {
      update_grid_images("all_images");
      global_image_key = "all_images";
    }
    else if ($("#images-category").val() == "Main Images") {
      update_grid_images("main_images");
      global_image_key = "main_images";
    }
    else if ($("#images-category").val() == "Sub Images") {
      update_grid_images("sub_images");
      global_image_key = "sub_images";
    }
    else if ($("#images-category").val() == "PFL Images") {
      update_grid_images("pfl_images");
      global_image_key = "pfl_images";
    }
    else if ($("#images-category").val() == "PFL Generated Images") {
      update_grid_images("pfl_generated_images");
      global_image_key = "pfl_generated_images";
    }
    else if ($("#images-category").val() == "White Background Images") {
      update_grid_images("white_background_images");
      global_image_key = "white_background_images";
    }
    else if ($("#images-category").val() == "Lifestyle Images") {
      update_grid_images("lifestyle_images");
      global_image_key = "lifestyle_images";
    }
    else if ($("#images-category").val() == "Certificate Images") {
      update_grid_images("certificate_images");
      global_image_key = "certificate_images";
    }
    else if ($("#images-category").val() == "Giftbox Images") {
      update_grid_images("giftbox_images");
      global_image_key = "giftbox_images";
    }
    else if ($("#images-category").val() == "Diecut Images") {
      update_grid_images("diecut_images");
      global_image_key = "diecut_images";
    }
    else if ($("#images-category").val() == "A+ Content Images") {
      update_grid_images("aplus_content_images");
      global_image_key = "aplus_content_images";
    }
    else if ($("#images-category").val() == "Ads Images") {
      update_grid_images("ads_images");
      global_image_key = "ads_images";
    }
    else if ($("#images-category").val() == "Unedited Images") {
      update_grid_images("unedited_images");
      global_image_key = "unedited_images";
    }
    else if($("#images-category").val()=="Transparent Images")
    {
       update_grid_images("transparent_images");
      global_image_key = "transparent_images";
    }
  });


  function save_pfl_image_to_bucket() {
    var pfl_product_name = $("#pfl-product-name").val();

    var seller_sku = $("#seller-sku").val();

    var image_links = [];

    //Set the images
    if (global_images["main_images"].length > 0) {
      $("#pfl-product-image-preview-img").attr("src", global_images["main_images"][0]["main-url"]);
    }

    //$("#brand-image-img").attr("src", "");
    //$("#barcode-image-preview-img").attr("src", "");


    if ($("#pfl-product-image-preview-img").attr("src") != "") {
      image_links.push({
        "key": "product_image",
        "url": $("#pfl-product-image-preview-img").attr("src")
      });
    }

    if ($("#brand-image-img").attr("src") != "") {
      image_links.push({
        "key": "brand_image",
        "url": $("#brand-image-img").attr("src")
      });
    }

    if ($("#barcode-image-preview-img").attr("src") != "") {
      image_links.push({
        "key": "barcode_image",
        "url": $("#barcode-image-preview-img").attr("src")
      });
    }


    $("#seller-sku-preview").html(seller_sku);

    var html_string = `<br><br>`;
    var feature_text = $(".feature-text");
    for (var i = 0; i < feature_text.length; i++) {
      html_string += `<span style="font-family: 'AvenirNextRegular'"><span style="color:#521893;">&bullet;&nbsp;&nbsp;</span> ` + feature_text[i].value + `</span><br>`
    }
    $("#features-preview-div").html(html_string);

    $("#product-name-preview").text(pfl_product_name);


    $.ajax({
      url: "/download-images-s3/",
      type: "POST",
      headers: {
        'X-CSRFToken': getCsrfToken()
      },
      data: {
        links: JSON.stringify(image_links)
      },
      success: function (response) {
        console.log("Success! ", response);
        if (response["status"] == 200) {
          var local_links = response["local_links"];

          for (var i = 0; i < response["local_links"].length; i++) {
            if (local_links[i]["key"] == "product_image") {
              $("#pfl-product-image-preview-img").attr("src", local_links[i]["url"]);
              $("#pfl-product-image-preview-img").show();
            }
            else if (local_links[i]["key"] == "brand_image") {
              $("#brand-image-img").attr("src", local_links[i]["url"]);
              $("#brand-image-img").show();
            }
            else if (local_links[i]["key"] == "barcode_image") {
              $("#barcode-image-preview-img").attr("src", local_links[i]["url"]);
              $("#barcode-image-preview-img").show();
            }
          }

          $('#pfl-div').css("display", "block");

          html2canvas($("#pfl-div"), {
            logging: true,
            dpi: 600,
            scale: 3,
            onrendered: function (canvas) {

              $("#pfl-div").hide();
              var image_data = canvas.toDataURL();

              var fd = new FormData();
              fd.append('image_data', image_data);
              fd.append('product_pk', window.location.pathname.split("/")[2]);

              $.ajax({
                url: "/save-pfl-in-bucket/",
                type: "POST",
                headers: {
                  'X-CSRFToken': getCsrfToken()
                },
                processData: false,
                contentType: false,
                data: fd,
                success: function (response) {
                  console.log("Success!", response);
                  if (response["status"] == 200) {
                    global_images["pfl_generated_images"] = [{
                      "main-url": response["main-url"],
                      "midimage-url": response["midimage-url"],
                      "thumbnail-url": response["thumbnail-url"]
                    }];
                    if (global_image_key != "sub_images") {
                      update_grid_images(global_image_key);
                    }

                    if (global_image_key == "pfl_generated_images") {
                      $($(".miniimage")[0]).click();
                    }
                  }
                },
                error: function (xhr, textstatus, errorthrown) {
                  console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
                }
              });
            }
          });
        }
      },
      error: function (xhr, textstatus, errorthrown) {
        console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
      }
    });
  }

  function save_product() {
    //save_pfl_image_to_bucket();

    $("#save-btn").attr("disabled", "disabled");

    var product_pk = window.location.pathname.split("/")[2];
    var product_name = $("#product-name").val();
    var product_id = $("#product-id").val();
    var product_id_type = $("#product-id-type").val();
    var barcode_string = $("#barcode-string").val();
    var color_map = $("#color-map").val();
    var color = $("#color").val();
    var material_type = $("#material-type").val();
    var standard_price = $("#standard-price").val();
    var quantity = $("#quantity").val();
    var factory_notes = $("#factory-notes").val();

    var pfl_product_name = $("#pfl-product-name").val();
    var pfl_product_features = [];
    for (var i = 0; i < $(".feature-text").length; i++) {
      pfl_product_features.push($(".feature-text")[i].value);
    }

    var fd = new FormData();

    fd.append('product_pk', product_pk);
    fd.append('product_name', product_name);
    fd.append('product_id', product_id);
    fd.append('product_id_type', product_id_type);
    fd.append('barcode_string', barcode_string);
    fd.append('color_map', color_map);
    fd.append('color', color);
    fd.append('material_type', material_type);
    fd.append('standard_price', standard_price);
    fd.append('quantity', quantity);
    fd.append('factory_notes', factory_notes);
    fd.append('pfl_product_name', pfl_product_name)
    fd.append('pfl_product_features', JSON.stringify(pfl_product_features));

    $.ajax({
      url: "/save-product/",
      type: "POST",
      headers: {
        'X-CSRFToken': getCsrfToken()
      },
      processData: false,
      contentType: false,
      data: fd,
      success: function (response) {

        console.log("Success!", response);
        if (response["status"] == 200) {
          M.toast({ html: "Product saved successfully!" });
        }
        else if (response["status"] == 409) {
          M.toast({ html: "Product ID or Seller SKU is duplicated!" });
        }
        else if (response["status"] == 403) {
          M.toast({ html: "You do not have permission for saving product!" });
        }
        else {
          M.toast({ html: "Error saving product!" });
        }
        $("#save-btn").removeAttr("disabled");
      },
      error: function (xhr, textstatus, errorthrown) {
        console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
      }
    });

    //save_subimages_index();
  }


  $("#save-btn").click(function () {

    if ($("#product-id").val().trim() == "") {
      M.toast({ html: "Product ID cannot be empty!" });
      return;
    }

    save_product();
  });

  $(window).keydown(function (event) {
    //console.log(event.which, event.keyCode, event.ctrlKey);
    if (event.which == 83 && event.ctrlKey) {
      event.preventDefault();
      save_product();
      return false;
    }
  });
</script>

{% endblock %}